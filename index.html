<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","Sidebar Display (only for Muse | Mist), available values":["always  expand for all pages automatically."],"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="yhzhuang">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="yhzhuang">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zyh">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>yhzhuang</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yhzhuang</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>resources</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/12/oslab9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/12/oslab9/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-07-12 10:40:15" itemprop="dateCreated datePublished" datetime="2024-07-12T10:40:15+08:00">2024-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-07-13 17:23:09" itemprop="dateModified" datetime="2024-07-13T17:23:09+08:00">2024-07-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å®éªŒè¯¾ç¨‹:                   æ“ä½œç³»ç»Ÿ</p>
<h1 id="å®éªŒåç§°-Lab9-malloc-free"><a href="#å®éªŒåç§°-Lab9-malloc-free" class="headerlink" title="å®éªŒåç§°:          Lab9 malloc-free"></a><strong>å®éªŒåç§°:          Lab9 malloc-free</strong></h1><ul>
<li>å­¦ç”Ÿå§“å:                    åº„äº‘çš“</li>
<li>å­¦ç”Ÿå­¦å·:                   22336327</li>
</ul>
<h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><p>å®ç°ç³»ç»Ÿè°ƒç”¨mallocå’Œfreeã€‚mallocç”¨äºåˆ†é…ä»»æ„å­—èŠ‚çš„å†…å­˜ï¼Œfreeç”¨äºé‡Šæ”¾ä»»æ„å­—èŠ‚çš„å†…å­˜ã€‚</p>
<p>æŒ‰ç…§æ•™ç¨‹ä¸­ç»™çš„ä»£ç å¤ç°å®éªŒï¼Œå¹¶å¯¹åŠ å…¥åŒæ­¥äº’æ–¥ä»£ç ä»¥ä¿è¯ä¿è¯åŠ¨æ€å†…å­˜åˆ†é…æ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<h2 id="2-å®éªŒè¿‡ç¨‹"><a href="#2-å®éªŒè¿‡ç¨‹" class="headerlink" title="2. å®éªŒè¿‡ç¨‹"></a>2. <strong>å®éªŒè¿‡ç¨‹</strong></h2><p><strong>åŸºæœ¬æ€è·¯</strong></p>
<p>åˆ†é…ğ‘ ğ‘–ğ‘§ğ‘’ä¸ªå­—èŠ‚çš„å†…å­˜æ—¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªğ‘ï¼Œæ»¡è¶³2^(ğ‘âˆ’1)&lt;ğ‘ ğ‘–ğ‘§ğ‘’â‰¤2^ğ‘</p>
<p>ä¹Ÿå°±æ˜¯ä»å°åˆ°å¤§æœç´¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ°å¥½ä¸å°äºğ‘ ğ‘–ğ‘§ğ‘’çš„arenaã€‚æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªarenaåï¼Œæˆ‘ä»¬ä¾¿è¿”å›arenaçš„èµ·å§‹åœ°å€ä½œä¸ºåˆ†é…çš„ç»“æœã€‚ç‰¹åˆ«åœ°ï¼Œå½“æ²¡æœ‰arenaèƒ½å¤ŸåŒ…å«ğ‘ ğ‘–ğ‘§ğ‘’ä¸ªå­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬å°±åˆ†é…è¿ç»­çš„ğ‘€ä¸ªé¡µï¼Œä½¿å¾—(ğ‘€âˆ’1)Ã—4096&lt;ğ‘ ğ‘–ğ‘§ğ‘’â‰¤ğ‘€Ã—4096</p>
<p>è¿”å›è¿™ğ‘€ä¸ªé¡µçš„èµ·å§‹åœ°å€ä½œä¸ºåˆ†é…çš„ç»“æœã€‚</p>
<p><strong>è¿‡ç¨‹</strong></p>
<p>å…ˆåœ¨setupå‡½æ•°ä¸­è®¾ç½®ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®4å·ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">systemService.<span class="built_in">setSystemCall</span>(<span class="number">4</span>, (<span class="type">int</span>)syscall_malloc);</span><br><span class="line"><span class="comment">//è®¾ç½®5å·ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">systemService.<span class="built_in">setSystemCall</span>(<span class="number">5</span>, (<span class="type">int</span>)syscall_free);</span><br></pre></td></tr></table></figure>

<p>åœ¨system_call.cppä¸­åŠ å…¥</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">malloc</span><span class="params">(<span class="type">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="built_in">asm_system_call</span>(<span class="number">4</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* address)</span></span>&#123;</span><br><span class="line">    <span class="built_in">asm_system_call</span>(<span class="number">5</span>,(<span class="type">int</span>)address);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬éœ€è¦å®Œå–„è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼š</p>
<p><code>void* syscall_malloc(intsize)</code>å’Œ <code>void syscall_free(void*address)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">syscall_malloc</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PCB *pcb = programManager.running;</span><br><span class="line">    <span class="keyword">if</span> (pcb-&gt;pageDirectoryAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ¯ä¸€ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„ByteMemoryManager</span></span><br><span class="line">        <span class="keyword">return</span> pcb-&gt;byteMemoryManager.<span class="built_in">allocate</span>(size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å†…æ ¸çº¿ç¨‹å…±äº«ä¸€ä¸ªByteMemoryManager</span></span><br><span class="line">        <span class="keyword">return</span> kernelByteMemoryManager.<span class="built_in">allocate</span>(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">syscall_free</span><span class="params">(<span class="type">void</span> *address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PCB *pcb = programManager.running;</span><br><span class="line">    <span class="keyword">if</span> (pcb-&gt;pageDirectoryAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        pcb-&gt;byteMemoryManager.<span class="built_in">release</span>(address);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        kernelByteMemoryManager.<span class="built_in">release</span>(address);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨memory.hä¸­å®šä¹‰</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MemoryManageræ˜¯åœ¨å†…æ ¸æ€è°ƒç”¨çš„å†…å­˜ç®¡ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ByteMemoryManager</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 16, 32, 64, 128, 256, 512, 1024</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> MEM_BLOCK_TYPES = <span class="number">7</span>;       <span class="comment">// å†…å­˜å—çš„ç±»å‹æ•°ç›®</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> minSize = <span class="number">16</span>;              <span class="comment">// å†…å­˜å—çš„æœ€å°å¤§å°</span></span><br><span class="line">    <span class="type">int</span> arenaSize[MEM_BLOCK_TYPES];             <span class="comment">// æ¯ç§ç±»å‹å¯¹åº”çš„å†…å­˜å—å¤§å°</span></span><br><span class="line">    MemoryBlockListItem *arenas[MEM_BLOCK_TYPES]; <span class="comment">// æ¯ç§ç±»å‹çš„arenaå†…å­˜å—çš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ByteMemoryManager</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> *<span class="title">allocate</span><span class="params">(<span class="type">int</span> size)</span></span>;  <span class="comment">// åˆ†é…ä¸€å—åœ°å€</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">(<span class="type">void</span> *address)</span></span>; <span class="comment">// é‡Šæ”¾ä¸€å—åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getNewArena</span><span class="params">(AddressPoolType type, <span class="type">int</span> index)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ByteMemoryManageråˆå§‹åŒ–ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ByteMemoryManager::<span class="built_in">ByteMemoryManager</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">initialize</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteMemoryManager::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = minSize;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MEM_BLOCK_TYPES; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        arenas[i] = <span class="literal">nullptr</span>;</span><br><span class="line">        arenaSize[i] = size;</span><br><span class="line">        size = size &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ä»¥ä¸‹æ˜¯å†…å­˜åˆ†é…çš„å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">ByteMemoryManager::allocate</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; MEM_BLOCK_TYPES &amp;&amp; arenaSize[index] &lt; size)</span><br><span class="line">        ++index;</span><br><span class="line"></span><br><span class="line">    PCB *pcb = programManager.running;</span><br><span class="line">    AddressPoolType poolType = (pcb-&gt;pageDirectoryAddress) ? AddressPoolType::USER : AddressPoolType::KERNEL;</span><br><span class="line">    <span class="type">void</span> *ans = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == MEM_BLOCK_TYPES)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¸Šå–æ•´</span></span><br><span class="line">        <span class="type">int</span> pageAmount = (size + <span class="built_in">sizeof</span>(Arena) + PAGE_SIZE - <span class="number">1</span>) / PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        ans = memoryManager.<span class="built_in">allocatePages</span>(poolType, pageAmount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ans)</span><br><span class="line">        &#123;</span><br><span class="line">            Arena *arena = (Arena *)ans;</span><br><span class="line">            arena-&gt;type = ArenaType::ARENA_MORE;</span><br><span class="line">            arena-&gt;counter = pageAmount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;---ByteMemoryManager::allocate----\n&quot;);</span></span><br><span class="line">        <span class="keyword">if</span> (arenas[index] == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">getNewArena</span>(poolType, index))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯æ¬¡å–å‡ºå†…å­˜å—é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå†…å­˜å—</span></span><br><span class="line">        ans = arenas[index];</span><br><span class="line">        arenas[index] = ((MemoryBlockListItem *)ans)-&gt;next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arenas[index])</span><br><span class="line">        &#123;</span><br><span class="line">            (arenas[index])-&gt;previous = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Arena *arena = (Arena *)((<span class="type">int</span>)ans &amp; <span class="number">0xfffff000</span>);</span><br><span class="line">        --(arena-&gt;counter);</span><br><span class="line">        <span class="comment">//printf(&quot;---ByteMemoryManager::allocate----\n&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç©ºé—²arenaé“¾è¡¨ä¸ºç©ºï¼Œåˆ™éœ€è¦ä»å†…æ ¸ä¸­åˆ†é…ä¸€ä¸ªé¡µï¼Œå†™å…¥å…ƒä¿¡æ¯ï¼Œç„¶åå°†è¯¥é¡µåˆ’åˆ†æˆä¸€ä¸ªä¸ªarenaã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteMemoryManager::getNewArena</span><span class="params">(AddressPoolType type, <span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span> *ptr = memoryManager.<span class="built_in">allocatePages</span>(type, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜å—çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> times = (PAGE_SIZE - <span class="built_in">sizeof</span>(Arena)) / arenaSize[index];</span><br><span class="line">    <span class="comment">// å†…å­˜å—çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="type">int</span> address = (<span class="type">int</span>)ptr + <span class="built_in">sizeof</span>(Arena);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•ä¸‹å†…å­˜å—çš„æ•°æ®</span></span><br><span class="line">    Arena *arena = (Arena *)ptr;</span><br><span class="line">    arena-&gt;type = (ArenaType)index;</span><br><span class="line">    arena-&gt;counter = times;</span><br><span class="line">    <span class="comment">// printf(&quot;---ByteMemoryManager::getNewArena: type: %d, arena-&gt;counter: %d\n&quot;, index, arena-&gt;counter);</span></span><br><span class="line"></span><br><span class="line">    MemoryBlockListItem *prevPtr = (MemoryBlockListItem *)address;</span><br><span class="line">    MemoryBlockListItem *curPtr = <span class="literal">nullptr</span>;</span><br><span class="line">    arenas[index] = prevPtr;</span><br><span class="line">    prevPtr-&gt;previous = <span class="literal">nullptr</span>;</span><br><span class="line">    prevPtr-&gt;next = <span class="literal">nullptr</span>;</span><br><span class="line">    --times;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (times)</span><br><span class="line">    &#123;</span><br><span class="line">        address += arenaSize[index];</span><br><span class="line">        curPtr = (MemoryBlockListItem *)address;</span><br><span class="line">        prevPtr-&gt;next = curPtr;</span><br><span class="line">        curPtr-&gt;previous = prevPtr;</span><br><span class="line">        curPtr-&gt;next = <span class="literal">nullptr</span>;</span><br><span class="line">        prevPtr = curPtr;</span><br><span class="line">        --times;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°å†…å­˜é‡Šæ”¾ã€‚</p>
<p>å†…å­˜é‡Šæ”¾éå¸¸ç®€å•ï¼Œå½“æˆ‘ä»¬é‡Šæ”¾ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„å†…å­˜åœ°å€æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™ä¸ªåœ°å€æ‰€åœ¨çš„é¡µã€‚ç„¶åé€šè¿‡è¿™ä¸ªé¡µå¼€å¤´ä¿å­˜çš„å…ƒä¿¡æ¯å°±èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªåœ°å€å¯¹åº”çš„arenaç±»å‹ã€‚æœ€åå°†è¿™ä¸ªarenaæ”¾åˆ°å¯¹åº”çš„ç©ºé—²arenaé“¾è¡¨å³å¯ã€‚</p>
<p>ç‰¹åˆ«åœ°ï¼Œå½“ä¸€ä¸ªé¡µå†…çš„æ‰€æœ‰arenaéƒ½è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾è¿™ä¸ªé¡µã€‚</p>
<p>æ•™ç¨‹ä¸­çš„ä»£ç æœ‰ä¸€äº›æ‹¼å†™é—®é¢˜å’Œreleaseæ²¡æœ‰æŒ‡å®šå†…å­˜æ± æ˜¯kernelè¿˜æ˜¯userçš„é—®é¢˜ï¼Œè¿›è¡Œäº†ä¿®æ”¹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteMemoryManager::release</span><span class="params">(<span class="type">void</span> *address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç”±äºArenaæ˜¯æŒ‰é¡µåˆ†é…çš„ï¼Œæ‰€ä»¥å…¶é¦–åœ°å€çš„ä½12ä½å¿…å®š0ï¼Œ</span></span><br><span class="line">    <span class="comment">// å…¶ä¸­åˆ’åˆ†çš„å†…å­˜å—çš„é«˜20ä½ä¹Ÿå¿…å®šä¸å…¶æ‰€åœ¨çš„Arenaé¦–åœ°å€ç›¸åŒ</span></span><br><span class="line">    Arena *arena = (Arena *)((<span class="type">int</span>)address &amp; <span class="number">0xfffff000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arena-&gt;type == ARENA_MORE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> address = (<span class="type">int</span>)arena;</span><br><span class="line"></span><br><span class="line">        memeoryManager.<span class="built_in">releasePage</span>(address, arena-&gt;counter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MemoryBlockListItem *itemPtr = (MemoryBlockListItem *)address;</span><br><span class="line">        itemPtr-&gt;next = arenas[arena-&gt;type];</span><br><span class="line">        itemPtr-&gt;previous = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (itemPtr-&gt;next)</span><br><span class="line">        &#123;</span><br><span class="line">            itemPtr-&gt;next-&gt;previous = itemPtr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        arenas[arena-&gt;type] = itemPtr;</span><br><span class="line">        ++(arena-&gt;counter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‹¥æ•´ä¸ªArenaè¢«å½’è¿˜ï¼Œåˆ™æ¸…ç©ºåˆ†é…ç»™Arenaçš„é¡µ</span></span><br><span class="line">        <span class="type">int</span> amount = (PAGE_SIZE - <span class="built_in">sizeof</span>(Arena)) / arenaSize[arena-&gt;type];</span><br><span class="line">        <span class="comment">// printf(&quot;---ByteMemoryManager::release---: arena-&gt;counter: %d, amount: %d\n&quot;, arena-&gt;counter, amount);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arena-&gt;counter == amount)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å°†å±äºArenaçš„å†…å­˜å—ä»é“¾ä¸Šåˆ é™¤</span></span><br><span class="line">            <span class="keyword">while</span> (itemPtr)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="type">int</span>)arena != ((<span class="type">int</span>)itemPtr &amp; <span class="number">0xfffff000</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    itemPtr = itemPtr-&gt;next;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (itemPtr-&gt;previous == <span class="literal">nullptr</span>) <span class="comment">// é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                &#123;</span><br><span class="line">                    arenas[arena-&gt;type] = itemPtr-&gt;next;</span><br><span class="line">                    <span class="keyword">if</span> (itemPtr-&gt;next)</span><br><span class="line">                    &#123;</span><br><span class="line">                        itemPtr-&gt;next-&gt;previous = <span class="literal">nullptr</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    itemPtr-&gt;previous-&gt;next = itemPtr-&gt;next;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (itemPtr-&gt;next)</span><br><span class="line">                &#123;</span><br><span class="line">                    itemPtr-&gt;next-&gt;previous = itemPtr-&gt;previous;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                itemPtr = itemPtr-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            memeoryManager.<span class="built_in">releasePage</span>((<span class="type">int</span>)address, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿›ç¨‹æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬ä¿®æ”¹PCBï¼Œåœ¨PCBä¸­åŠ å…¥ <code>ByteMemeoryManager</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct PCB</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    ByteMemoryManager byteMemoryManager; // è¿›ç¨‹å†…å­˜ç®¡ç†è€…</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨pcbåˆå§‹åŒ–å‡½æ•°ä¸­åŠ ä¸Š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread-&gt;byteMemoryManager.<span class="built_in">initialize</span>();</span><br></pre></td></tr></table></figure>

<p>setupå‡½æ•°ä¸­</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ByteMemoryManager kernelByteMemoryManager;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">setup_kernel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    kernelByteMemoryManager.<span class="built_in">initialize</span>();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="3-å…³é”®ä»£ç "><a href="#3-å…³é”®ä»£ç " class="headerlink" title="3. å…³é”®ä»£ç "></a>3. <strong>å…³é”®ä»£ç </strong></h2><p>è§ä¸Šä¸€éƒ¨åˆ†</p>
<h2 id="4-å®éªŒç»“æœ"><a href="#4-å®éªŒç»“æœ" class="headerlink" title="4. å®éªŒç»“æœ"></a>4. <strong>å®éªŒç»“æœ</strong></h2><p>æˆ‘ä»¬åœ¨è¿™é‡ŒåŠ ä¸Šå»¶è¿Ÿæ¥å±•ç¤ºæ²¡æœ‰å®ç°äº’æ–¥æ—¶å‘ç”Ÿçš„é”™è¯¯ï¼ŒåŒæ—¶æŠŠæ—¶é—´ç‰‡è½®è½¬çš„ticksè°ƒä½æ¥å¢åŠ å¹¶å‘åº¦</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">ByteMemoryManager::allocate</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	ans = arenas[index];</span><br><span class="line">        <span class="comment">//è®¾ç½®å»¶è¿Ÿ</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> delay = <span class="number">0xfffffff</span>;</span><br><span class="line">        <span class="keyword">while</span>(delay--);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥çœ‹è¿™ä¸ªæ ·ä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">second_thread</span><span class="params">(<span class="type">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* addr = <span class="built_in">malloc</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;first_thread get addr0(50) %x\n&quot;</span>, addr);</span><br><span class="line">    <span class="type">void</span>* addr1 = <span class="built_in">malloc</span>(<span class="number">30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;first_thread get addr1(30) %x\n&quot;</span>, addr1);</span><br><span class="line">    <span class="built_in">free</span>(addr);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">free</span>(addr1);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">third_thread</span><span class="params">(<span class="type">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* addr2 = <span class="built_in">malloc</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;second_thread get addr2(50) %x\n&quot;</span>,addr2);</span><br><span class="line">    <span class="built_in">free</span>(addr2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>thread</code>1å’Œ <code>tread2</code>éƒ½mallocäº†50B,åœ¨tread1è·å–äº†ansä¹‹åå»¶è¿Ÿï¼Œå¹¶æ²¡æœ‰è®¾ç½® <code>arenas[index] = ((MemoryBlockListItem *)ans)-&gt;next;</code>æ­¤æ—¶tread2è¢«è°ƒåº¦ä¸Šå¤„ç†æœºï¼Œè·å–äº†ä¸€æ ·çš„åœ°å€ã€‚</p>
<p>åˆ†é…äº†åŒæ ·çš„åœ°å€ä¼šå¯¼è‡´releaseçš„æ—¶å€™ä¹Ÿæ— æ³•å›æ”¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªçœ‹åˆ°äº†ä¸¤ä¸ªrelease.</p>
<p>æ— é”:</p>
<p><img src="/2024/07/12/oslab9/oslab9/1720841743990.png" alt="1720841743990"></p>
<p>æœ‰é”ï¼š</p>
<p>åœ¨è¿™é‡ŒåŠ ä¸Šé”ä¿è¯å¯¹arenaæ•°ç»„çš„äº’æ–¥è®¿é—®</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">ByteMemoryManager::allocate</span><span class="params">(<span class="type">int</span> size)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        bt_sem.<span class="built_in">P</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---ByteMemoryManager::allocate----\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (arenas[index] == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">getNewArena</span>(poolType, index))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;getNewArena\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯æ¬¡å–å‡ºå†…å­˜å—é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå†…å­˜å—</span></span><br><span class="line">        ans = arenas[index];</span><br><span class="line">        <span class="comment">//è®¾ç½®å»¶è¿Ÿ</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> delay = <span class="number">0xfffffff</span>;</span><br><span class="line">        <span class="keyword">while</span>(delay--);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">        arenas[index] = ((MemoryBlockListItem *)ans)-&gt;next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arenas[index])</span><br><span class="line">        &#123;</span><br><span class="line">            (arenas[index])-&gt;previous = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Arena *arena = (Arena *)((<span class="type">int</span>)ans &amp; <span class="number">0xfffff000</span>);</span><br><span class="line">        --(arena-&gt;counter);</span><br><span class="line">        <span class="comment">//printf(&quot;---ByteMemoryManager::allocate----\n&quot;);</span></span><br><span class="line">        bt_sem.<span class="built_in">V</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ é”ä¹‹ååœ¨ <code>thread1</code>å’Œ <code>tread2</code>éƒ½mallocäº†50Bæ—¶åˆ†é…çš„åœ°å€æ˜¯ä¸åŒçš„ã€‚å¯è§å®ç°äº†åˆ†é…æ—¶çš„äº’æ–¥ã€‚<code>thread1</code>åœ¨exitçš„æ—¶å€™å›æ”¶äº†èµ„æºï¼Œæ‰€ä»¥ <code>thread2</code>mallocåˆ†é…åˆ°çš„åœ°å€å’Œthread1æ˜¯ä¸€æ ·çš„ã€‚</p>
<p><img src="/2024/07/12/oslab9/oslab9/1720841689908.png" alt="1720841689908"></p>
<p>åœ¨å…¶ä»–éœ€è¦äº’æ–¥çš„åœ°æ–¹åŠ ä¸Šä¿¡å·é‡ï¼š</p>
<p>è¿™é‡ŒåŠ ä¸Šæ˜¯ä¸ºäº†ä¿è¯åœ¨ä¸ºè¿›ç¨‹åˆ†é…å†…å­˜çš„æ—¶å€™å®ç°çš„äº’æ–¥ä»¥åŠmallocåˆ†é…ç©ºé—´&gt;1024Byteæ—¶çš„åˆ†é…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Semaphore semaphore;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemoryManager::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">initialize</span>(<span class="number">1</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MemoryManager::allocatePages</span><span class="params">(<span class="keyword">enum</span> AddressPoolType type, <span class="type">const</span> <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">P</span>();</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼šä»è™šæ‹Ÿåœ°å€æ± ä¸­åˆ†é…è‹¥å¹²è™šæ‹Ÿé¡µ</span></span><br><span class="line">    <span class="type">int</span> virtualAddress = <span class="built_in">allocateVirtualPages</span>(type, count);</span><br><span class="line">    ...</span><br><span class="line">    semaphore.<span class="built_in">V</span>();</span><br><span class="line">    <span class="keyword">return</span> virtualAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºè¿›ç¨‹æ¥è¯´ï¼Œä¹Ÿèƒ½é€šè¿‡ç³»ç»Ÿè°ƒç”¨å®ç°æ­£å¸¸åˆ†é…å†…å­˜ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">first_process</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span>* addr = <span class="built_in">malloc</span>(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;first_process get addr0(50) %x\n&quot;</span>, addr);</span><br><span class="line">    <span class="type">void</span>* addr1 = <span class="built_in">malloc</span>(<span class="number">30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;first_process get addr1(30) %x\n&quot;</span>, addr1);</span><br><span class="line">    <span class="built_in">free</span>(addr);</span><br><span class="line">    <span class="built_in">free</span>(addr1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><img src="/2024/07/12/oslab9/oslab9/1720857389774.png" alt="1720857389774"></p>
<h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. <strong>æ€»ç»“</strong></h2><p>è¿™æ¬¡å®éªŒå¯ä»¥è¯´æ¯”è¾ƒç»¼åˆï¼Œæ¶‰åŠåˆ°å†…å­˜ç®¡ç†ã€ç³»ç»Ÿè°ƒç”¨ã€çº¿ç¨‹äº’æ–¥ç­‰å¤šæ–¹é¢çš„å†…å®¹ï¼Œè™½ç„¶è¯´æ•´ä½“éš¾åº¦ä¸å¤§åªéœ€è¦åœ¨æ•™ç¨‹ç»™å‡ºçš„ä»£ç ä¸Šè¿›è¡Œä¿®æ”¹ä½†æ˜¯è¿˜æ˜¯è¦å®Œå…¨ç†è§£è¿˜æ˜¯æœ‰äº›éš¾åº¦ã€‚å®éªŒä¸­é‡åˆ°äº†æ²¡æœ‰åœ¨setup.cppå‡½æ•°ä¸­BytememoryManagemebt.initalize()ï¼Œå¯¼è‡´è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°sizeéƒ½è¢«åˆå§‹åŒ–ä¸º0çš„é—®é¢˜ã€‚åæ¥å‘ç°å¹¶è§£å†³äº†ã€‚å®éªŒæ•™ç¨‹ä¸­é‡‡ç”¨äº†ä¸åŒå¤§å°çš„å—è¿›è¡ŒåŠ¨æ€å†…å­˜åˆ†é…ï¼Œå‡å°‘äº†ç¢ç‰‡ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆç²¾å·§çš„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/20/oslab7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/20/oslab7/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-05-20 09:55:50" itemprop="dateCreated datePublished" datetime="2024-05-20T09:55:50+08:00">2024-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-06-03 09:04:05" itemprop="dateModified" datetime="2024-06-03T09:04:05+08:00">2024-06-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!---
title:SYSU-2024æ“ä½œç³»ç»Ÿlab3å®éªŒæŠ¥å‘Š

date:2024-03-24 23:54:26

tags:os

comments:true

author:zyh
--->

<p>å®éªŒè¯¾ç¨‹:                   æ“ä½œç³»ç»Ÿ</p>
<h1 id="å®éªŒåç§°-Lab7-å†…å­˜ç®¡ç†"><a href="#å®éªŒåç§°-Lab7-å†…å­˜ç®¡ç†" class="headerlink" title="å®éªŒåç§°:          Lab7 å†…å­˜ç®¡ç†"></a><strong>å®éªŒåç§°:          Lab7 å†…å­˜ç®¡ç†</strong></h1><ul>
<li>å§“å:                    åº„äº‘çš“</li>
<li>å­¦å·:                   22336327</li>
</ul>
<h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><h3 id="Assignment-1"><a href="#Assignment-1" class="headerlink" title="Assignment 1"></a>Assignment 1</h3><p>å¤ç°å‚è€ƒä»£ç ï¼Œå®ç°äºŒçº§åˆ†é¡µæœºåˆ¶ï¼Œå¹¶èƒ½å¤Ÿåœ¨è™šæ‹Ÿæœºåœ°å€ç©ºé—´ä¸­è¿›è¡Œå†…å­˜ç®¡ç†ï¼ŒåŒ…æ‹¬å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ç­‰ï¼Œæˆªå›¾å¹¶ç»™å‡ºè¿‡ç¨‹è§£é‡Šã€‚</p>
<h3 id="Assignment-2"><a href="#Assignment-2" class="headerlink" title="Assignment 2"></a>Assignment 2</h3><p>å‚ç…§ç†è®ºè¯¾ä¸Šçš„å­¦ä¹ çš„ç‰©ç†å†…å­˜åˆ†é…ç®—æ³•å¦‚first-fit, best-fitç­‰å®ç°åŠ¨æ€åˆ†åŒºç®—æ³•ç­‰ï¼Œæˆ–è€…è‡ªè¡Œæå‡ºè‡ªå·±çš„ç®—æ³•ã€‚</p>
<h3 id="Assignment-3"><a href="#Assignment-3" class="headerlink" title="Assignment 3"></a>Assignment 3</h3><p>å¤ç°â€œè™šæ‹Ÿé¡µå†…å­˜ç®¡ç†â€ä¸€èŠ‚çš„ä»£ç ï¼Œå®Œæˆå¦‚ä¸‹è¦æ±‚ã€‚</p>
<ul>
<li>ç»“åˆä»£ç åˆ†æè™šæ‹Ÿé¡µå†…å­˜åˆ†é…çš„ä¸‰æ­¥è¿‡ç¨‹å’Œè™šæ‹Ÿé¡µå†…å­˜é‡Šæ”¾ã€‚</li>
<li>æ„é€ æµ‹è¯•ä¾‹å­æ¥åˆ†æè™šæ‹Ÿé¡µå†…å­˜ç®¡ç†çš„å®ç°æ˜¯å¦å­˜åœ¨bugã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™å°è¯•ä¿®å¤å¹¶å†æ¬¡æµ‹è¯•ã€‚å¦åˆ™ï¼Œç»“åˆæµ‹ä¾‹ç®€è¦åˆ†æè™šæ‹Ÿé¡µå†…å­˜ç®¡ç†çš„å®ç°çš„æ­£ç¡®æ€§ã€‚</li>
<li>ï¼ˆ<strong>ä¸åšè¦æ±‚ï¼Œå¯¹è¯„åˆ†æ²¡æœ‰å½±å“</strong>ï¼‰å¦‚æœä½ æœ‰æƒ³æ³•ï¼Œå¯ä»¥åœ¨è‡ªå·±çš„ç†è§£çš„åŸºç¡€ä¸Šï¼Œå‚è€ƒucoreï¼Œã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹ï¼Œã€Šä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å®ç°ã€‹ç­‰èµ„æ–™æ¥å®ç°è‡ªå·±çš„è™šæ‹Ÿé¡µå†…å­˜ç®¡ç†ã€‚åœ¨å®Œæˆä¹‹åï¼Œä½ éœ€è¦æŒ‡æ˜ç›¸æ¯”è¾ƒäºæœ¬æ•™ç¨‹ï¼Œä½ çš„å®ç°çš„è™šæ‹Ÿé¡µå†…å­˜ç®¡ç†çš„ç‰¹ç‚¹æ‰€åœ¨ã€‚</li>
</ul>
<h3 id="Assignment-4"><a href="#Assignment-4" class="headerlink" title="Assignment 4"></a>Assignment 4</h3><p>å‚ç…§ç†è®ºè¯¾ä¸Šè™šæ‹Ÿå†…å­˜ç®¡ç†çš„é¡µé¢ç½®æ¢ç®—æ³•å¦‚FIFOã€LRUç­‰ï¼Œå®ç°é¡µé¢ç½®æ¢ï¼Œä¹Ÿå¯ä»¥æå‡ºè‡ªå·±çš„ç®—æ³•ã€‚</p>
<h2 id="2-å®éªŒè¿‡ç¨‹"><a href="#2-å®éªŒè¿‡ç¨‹" class="headerlink" title="2. å®éªŒè¿‡ç¨‹"></a>2. <strong>å®éªŒè¿‡ç¨‹</strong></h2><h3 id="Assignment1"><a href="#Assignment1" class="headerlink" title="Assignment1"></a><strong>Assignment1</strong></h3><p>BitMap</p>
<p><code>setup.cpp</code>ä¸­</p>
<p><code>char*pages_0= (char*)memoryManager.allocatePhysicalPages(AddressPoolType::KERNEL, 128);</code></p>
<p>è°ƒç”¨äº† <code>MemoryManager</code>çš„æˆå‘˜å‡½æ•°allocatePhisicalPages</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717171735091.png" alt="1717171735091"></p>
<p>æ¥ç€æˆ‘ä»¬è¿›å…¥ <code>allocatePhysicalPages</code>,è¿™é‡Œçš„resourcesæ˜¯ä¸€ä¸ªBitmapå˜é‡ï¼Œallocateåœ¨ç»™çš„ä»£ç ä¸­é»˜è®¤é‡‡ç”¨çš„æ˜¯first_fitçš„ç®—æ³•ï¼Œ<code>Bitmap::allocate</code>çš„åŠŸèƒ½æ˜¯æŒ‰ç…§åˆ†é…æ–¹å¼æ‰¾åˆ°ä½å›¾å¯¹åº”çš„ä½ç½®ï¼Œéƒ½ç½®ä¸º1ã€‚ä½å›¾ä½ä¸å†…æ ¸ç©ºé—´ä¸­ã€‚</p>
<p>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>Bitmap::allocate</code>çš„è¿”å›å€¼ä¸º0ï¼Œåˆ†é…å®Œ128pagesï¼Œåç¬¬äºŒæ¬¡è°ƒç”¨ <code>Bitmap::allocate</code>è¿”å›å€¼ä¸º128ï¼ˆè¿”å›å€¼ä¸ºåˆ†é…æ—¶bitmapæ•°ç»„çš„èµ·å§‹ä½ç½®ï¼‰</p>
<p>åˆ™ <code>AddressPool::allocate</code>çš„è¿”å›å€¼ä¸ºPAGE_SIZE*start+startAddress å³ä»å“ªä¸ªåœ°å€å¼€å§‹åˆ†é… ,è¿™é‡Œçš„startAddresså¯è®¤ä¸ºæ˜¯èµ·å§‹åœ°å€çš„åŸºå€ï¼Œæ˜¯2097152ï¼Œå³0x200000ã€‚</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717172406777.png" alt="1717172406777"></p>
<p>releaseçš„è¿‡ç¨‹ç±»ä¼¼:(address - startAddress&#x2F;PAGE_SIZE)ç®—å‡ºbitmapå¯¹åº”çš„ä½ç½®index,ç„¶åä»è¯¥ä½ç½®å¼€å§‹æŠŠåé¢countä¸ªå…ƒç´ ç½®é›¶ã€‚</p>
<h3 id="Assignment2"><a href="#Assignment2" class="headerlink" title="Assignment2"></a><strong>Assignment2</strong></h3><ul>
<li>first_fitï¼šä»ä½åœ°å€å¼€å§‹æœç´¢,æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³è¯·æ±‚å—çš„ç©ºé—²åˆ†åŒº</li>
<li>best_fitï¼šä»æ‰€æœ‰å¯ç”¨åˆ†åŒºä¸­æ‰¾åˆ°æœ€å°çš„èƒ½å¤Ÿæ»¡è¶³è¯·æ±‚çš„åˆ†åŒº</li>
<li>worst_fitï¼šä»æ‰€æœ‰å¯ç”¨åˆ†åŒºä¸­æ‰¾åˆ°æœ€å¤§çš„èƒ½å¤Ÿæ»¡è¶³è¯·æ±‚çš„åˆ†åŒº<br>å…·ä½“å®ç°è§å…³é”®ä»£ç å¤„</li>
</ul>
<h3 id="Assignment3"><a href="#Assignment3" class="headerlink" title="Assignment3"></a><strong>Assignment3</strong></h3><p>è™šæ‹Ÿé¡µå†…å­˜åˆ†é…çš„ä¸‰æ­¥ï¼š</p>
<ul>
<li><strong>ä»è™šæ‹Ÿåœ°å€æ± ä¸­åˆ†é…è¿ç»­çš„å¤šä¸ªè™šæ‹Ÿé¡µ</strong> ã€‚<img src="/2024/05/20/oslab7/oslab7/1717297841023.png" alt="1717297841023"><br>æˆ‘ä»¬å»ºç«‹äº†ç”¨æˆ·è™šæ‹Ÿåœ°å€æ± ,é¦–å…ˆå®šä¹‰è™šæ‹Ÿåœ°å€èµ·å§‹åœ°å€çš„å®ï¼Œä½¿å¾—åˆ†é…çš„é¡µç©ºé—´è™šæ‹Ÿåœ°å€ä»…åœ¨3-4GBä¹‹<br>é—´</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KERNEL_VIRTUAL_START 0xc0100000</span></span><br></pre></td></tr></table></figure>

<p>  ä»åœ°å€æ± ä¸­åˆ†é…countä¸ªè¿ç»­é¡µçš„è¿‡ç¨‹åœ¨assignment1ä¸­å·²ç»æåˆ°ï¼Œä¸å†èµ˜è¿°ã€‚<br>è¿™æ˜¯ <code>kernel/memory.cpp</code>ä¸­çš„ <code>MemoryManager::allocatePages</code>å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MemoryManager::allocatePages</span><span class="params">(<span class="keyword">enum</span> AddressPoolType type, <span class="type">const</span> <span class="type">int</span> count)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ­¥ï¼šä»è™šæ‹Ÿåœ°å€æ± ä¸­åˆ†é…è‹¥å¹²è™šæ‹Ÿé¡µ</span></span><br><span class="line"><span class="type">int</span> virtualAddress = <span class="built_in">allocateVirtualPages</span>(type, count);</span><br><span class="line"><span class="keyword">if</span> (!virtualAddress)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å¼€å§‹ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿé¡µæŒ‡å®šç‰©ç†é¡µï¼Œè¿™ä»¶äº‹åˆ†ä¸ºä¸¤æ­¥ï¼Œå…ˆåˆ†é…è™šæ‹Ÿé¡µï¼Œå†å»ºç«‹è™šæ‹Ÿé¡µå’Œç‰©ç†é¡µçš„è”ç³»ã€‚åˆ†é…è¿‡ç¨‹å’Œä¹‹å‰ä¸€æ ·</p>
<ul>
<li><strong>ä»ç‰©ç†åœ°å€æ± ä¸­ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿé¡µåˆ†é…ç›¸åº”å¤§å°çš„ç‰©ç†é¡µ</strong> ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> flag;</span><br><span class="line"><span class="type">int</span> physicalPageAddress;</span><br><span class="line"><span class="type">int</span> vaddress = virtualAddress;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾æ¬¡ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿé¡µæŒ‡å®šç‰©ç†é¡µ</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i, vaddress += PAGE_SIZE)</span><br><span class="line">&#123;</span><br><span class="line">    flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ç¬¬äºŒæ­¥ï¼šä»ç‰©ç†åœ°å€æ± ä¸­åˆ†é…ä¸€ä¸ªç‰©ç†é¡µ</span></span><br><span class="line">    physicalPageAddress = <span class="built_in">allocatePhysicalPages</span>(type, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (physicalPageAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;allocate physical page 0x%x\n&quot;, physicalPageAddress);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸‰æ­¥ï¼šä¸ºè™šæ‹Ÿé¡µå»ºç«‹é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹ï¼Œä½¿è™šæ‹Ÿé¡µå†…çš„åœ°å€ç»è¿‡åˆ†é¡µæœºåˆ¶å˜æ¢åˆ°ç‰©ç†é¡µå†…ã€‚</span></span><br><span class="line">        flag = <span class="built_in">connectPhysicalVirtualPage</span>(vaddress, physicalPageAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…å¤±è´¥ï¼Œé‡Šæ”¾å‰é¢å·²ç»åˆ†é…çš„è™šæ‹Ÿé¡µå’Œç‰©ç†é¡µè¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (!flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å‰iä¸ªé¡µè¡¨å·²ç»æŒ‡å®šäº†ç‰©ç†é¡µ</span></span><br><span class="line">        <span class="built_in">releasePages</span>(type, virtualAddress, i);</span><br><span class="line">        <span class="comment">// å‰©ä½™çš„é¡µè¡¨æœªæŒ‡å®šç‰©ç†é¡µ</span></span><br><span class="line">        <span class="built_in">releaseVirtualPages</span>(type, virtualAddress + i * PAGE_SIZE, count - i);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> virtualAddress;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>åœ¨é¡µç›®å½•è¡¨å’Œé¡µè¡¨ä¸­å»ºç«‹è™šæ‹Ÿé¡µå’Œç‰©ç†é¡µä¹‹é—´çš„å¯¹åº”å…³ç³»</strong> ã€‚æ­¤æ—¶ï¼Œç”±äºåˆ†é¡µæœºåˆ¶çš„å­˜åœ¨ï¼Œç‰©ç†é¡µçš„åœ°å€å¯ä»¥ä¸è¿ç»­ã€‚CPUçš„MMUä¼šåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€ã€‚</li>
</ul>
<p>æˆ‘ä»¬å…·ä½“æ¥çœ‹è¿™ä¸ªå‡½æ•°ï¼š<code>connectPhysicalVirtualPage(vaddress, physicalPageAddress);</code></p>
<p><img src="/2024/05/20/oslab7/oslab7/1717315484763.png" alt="1717315484763"></p>
<ul>
<li>é¦–å…ˆå¾—åˆ°è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µç›®å½•é¡¹pdeå’Œé¡µè¡¨é¡¹pte</li>
<li>å¦‚æœé¡µç›®å½•é¡¹æ— é¡µè¡¨åˆ™1.åˆ†é…ç‰©ç†é¡µç»™é¡µè¡¨   2.ä½¿é¡µç›®å½•é¡¹æŒ‡å‘é¡µè¡¨   3.è¿›è¡Œç©ºé—´çš„åˆ†é…</li>
<li>æœ‰çš„è¯ç›´æ¥å°†é¡µè¡¨é¡¹æŒ‡å‘ç‰©ç†é¡µ</li>
</ul>
<p>ä¸€äº›å…³é”®ä»£ç çš„è§£é‡Š:<br><code>*pde &amp; 0x00000001</code>è¡¨ç¤ºè·å–å­˜åœ¨ä½ï¼ˆPä½ï¼‰ï¼Œè‹¥ä¸º0åˆ™å–åˆ†é…ç‰©ç†é¡µ</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717316547661.png" alt="1717316547661"></p>
<p>å°†é¡µè¡¨é¡¹æŒ‡å‘ç‰©ç†é¡µï¼Œ<code>*physicalPageAddress | 0x7</code>ä¸­çš„æŒ‰ä½æˆ–è¿ç®—æ˜¯ä¸ºäº†è®¾ç½®é¡µç›®å½•é¡¹çš„æ ‡å¿—ä½</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MemoryManager::connectPhysicalVirtualPage</span><span class="params">(<span class="type">const</span> <span class="type">int</span> virtualAddress, <span class="type">const</span> <span class="type">int</span> physicalPageAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹</span></span><br><span class="line">    <span class="type">int</span> *pde = (<span class="type">int</span> *)<span class="built_in">toPDE</span>(virtualAddress);</span><br><span class="line">    <span class="type">int</span> *pte = (<span class="type">int</span> *)<span class="built_in">toPTE</span>(virtualAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¡µç›®å½•é¡¹æ— å¯¹åº”çš„é¡µè¡¨ï¼Œå…ˆåˆ†é…ä¸€ä¸ªé¡µè¡¨</span></span><br><span class="line">    <span class="keyword">if</span>(!(*pde &amp; <span class="number">0x00000001</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä»å†…æ ¸ç‰©ç†åœ°å€ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ªé¡µè¡¨</span></span><br><span class="line">        <span class="type">int</span> page = <span class="built_in">allocatePhysicalPages</span>(AddressPoolType::KERNEL, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!page)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿é¡µç›®å½•é¡¹æŒ‡å‘é¡µè¡¨</span></span><br><span class="line">        *pde = page | <span class="number">0x7</span>;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–é¡µè¡¨</span></span><br><span class="line">        <span class="type">char</span> *pagePtr = (<span class="type">char</span> *)(((<span class="type">int</span>)pte) &amp; <span class="number">0xfffff000</span>);</span><br><span class="line">        <span class="built_in">memset</span>(pagePtr, <span class="number">0</span>, PAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿é¡µè¡¨é¡¹æŒ‡å‘ç‰©ç†é¡µ</span></span><br><span class="line">    *pte = physicalPageAddress | <span class="number">0x7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾å†…å­˜è¿‡ç¨‹ï¼šåˆ†ä¸ºä¸¤æ­¥,é¦–å…ˆé‡Šæ”¾ç‰©ç†é¡µå†é‡Šæ”¾è™šæ‹Ÿé¡µã€‚</p>
<p>è¦æ³¨æ„æŠŠé¡µè¡¨é¡¹pteç½®ç©ºï¼Œé˜²æ­¢å†æ¬¡è¢«è®¿é—®ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemoryManager::releasePages</span><span class="params">(<span class="keyword">enum</span> AddressPoolType type, <span class="type">const</span> <span class="type">int</span> virtualAddress, <span class="type">const</span> <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> vaddr = virtualAddress;</span><br><span class="line">    <span class="type">int</span> *pte;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i, vaddr += PAGE_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œå¯¹æ¯ä¸€ä¸ªè™šæ‹Ÿé¡µï¼Œé‡Šæ”¾ä¸ºå…¶åˆ†é…çš„ç‰©ç†é¡µ</span></span><br><span class="line">        <span class="built_in">releasePhysicalPages</span>(type, <span class="built_in">vaddr2paddr</span>(vaddr), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®é¡µè¡¨é¡¹ä¸ºä¸å­˜åœ¨ï¼Œé˜²æ­¢é‡Šæ”¾åè¢«å†æ¬¡ä½¿ç”¨</span></span><br><span class="line">        pte = (<span class="type">int</span> *)<span class="built_in">toPTE</span>(vaddr);</span><br><span class="line">        *pte = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒæ­¥ï¼Œé‡Šæ”¾è™šæ‹Ÿé¡µ</span></span><br><span class="line">    <span class="built_in">releaseVirtualPages</span>(type, virtualAddress, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ‰“å°æµ‹è¯•ç”¨ä¾‹å‘ç°ï¼Œç¡®å®è¾¾åˆ°äº†è™šæ‹Ÿå†…å­˜è¿ç»­åˆ†é…ï¼Œç‰©ç†å†…å­˜åˆ†é…ä¸è¿ç»­çš„æ•ˆæœ</p>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *p1 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">100</span>);</span><br><span class="line">    <span class="type">char</span> *p2 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">10</span>);</span><br><span class="line">    <span class="type">char</span> *p3 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x %x %x\n&quot;</span>, p1, p2, p3);</span><br><span class="line"></span><br><span class="line">    memoryManager.<span class="built_in">releasePages</span>(AddressPoolType::KERNEL, (<span class="type">int</span>)p2, <span class="number">10</span>);</span><br><span class="line">    p2 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">    p2 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">10</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, p2);</span><br></pre></td></tr></table></figure>

<p>è™šæ‹Ÿå†…å­˜åˆ†é…ç»“æœ:p2é‡Šæ”¾åé‡æ–°åˆ†é…100é¡µçš„ç©ºé—´æ—¶ï¼Œä»0xc01d2000,è€Œåˆ†é…10é¡µç©ºé—´æ—¶ä»åŸæ¥é‡Šæ”¾å†…å­˜çš„0x164000å¼€å§‹</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717372803677.png" alt="1717372803677"></p>
<p>ç‰©ç†å†…å­˜åˆ™åœ¨åˆ†é…100é¡µæ—¶ä»åŸæ¥é‡Šæ”¾çš„åœ°å€çš„å¼€å§‹ï¼Œå¦‚æœå­”ç©ºé—´ä¸å¤Ÿç»§ç»­æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºçš„ç©ºé—´ã€‚</p>
<p>ä¸€äº›bug:</p>
<p>æ²¡æœ‰ä½¿ç”¨äº’æ–¥æœºåˆ¶å¯¼è‡´ä¸åŒçº¿ç¨‹å¯èƒ½éƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼Œåˆ†é…åˆ°ç›¸åŒçš„ç‰©ç†åœ°å€ã€‚æˆ‘ä»¬å»¶é•¿äº†ç­‰å¾…æ—¶é—´ä½¿å¾—è¿™ä¸ªé”™è¯¯å‘ç”Ÿã€‚å…·ä½“é”™è¯¯è§å®éªŒç»“æœå¤„ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ä¿¡å·é‡è§£å†³.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Semaphore semaphore;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MemoryManager::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">initialize</span>(<span class="number">1</span>);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MemoryManager::allocatePages</span><span class="params">(<span class="keyword">enum</span> AddressPoolType type, <span class="type">const</span> <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">P</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥ï¼šä»è™šæ‹Ÿåœ°å€æ± ä¸­åˆ†é…è‹¥å¹²è™šæ‹Ÿé¡µ</span></span><br><span class="line">    <span class="type">int</span> virtualAddress = <span class="built_in">allocateVirtualPages</span>(type, count);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!virtualAddress)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> flag;</span><br><span class="line">    <span class="type">int</span> physicalPageAddress;</span><br><span class="line">    <span class="type">int</span> vaddress = virtualAddress;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ä¾æ¬¡ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿé¡µæŒ‡å®šç‰©ç†é¡µ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i, vaddress += PAGE_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒæ­¥ï¼šä»ç‰©ç†åœ°å€æ± ä¸­åˆ†é…ä¸€ä¸ªç‰©ç†é¡µ</span></span><br><span class="line">        physicalPageAddress = <span class="built_in">allocatePhysicalPages</span>(type, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (physicalPageAddress)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;allocate physical page 0x%x\n&quot;, physicalPageAddress);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç¬¬ä¸‰æ­¥ï¼šä¸ºè™šæ‹Ÿé¡µå»ºç«‹é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹ï¼Œä½¿è™šæ‹Ÿé¡µå†…çš„åœ°å€ç»è¿‡åˆ†é¡µæœºåˆ¶å˜æ¢åˆ°ç‰©ç†é¡µå†…ã€‚</span></span><br><span class="line">            flag = <span class="built_in">connectPhysicalVirtualPage</span>(vaddress, physicalPageAddress);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            flag = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    semaphore.<span class="built_in">V</span>();</span><br><span class="line">        <span class="comment">// åˆ†é…å¤±è´¥ï¼Œé‡Šæ”¾å‰é¢å·²ç»åˆ†é…çš„è™šæ‹Ÿé¡µå’Œç‰©ç†é¡µè¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (!flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å‰iä¸ªé¡µè¡¨å·²ç»æŒ‡å®šäº†ç‰©ç†é¡µ</span></span><br><span class="line">            <span class="built_in">releasePages</span>(type, virtualAddress, i);</span><br><span class="line">            <span class="comment">// å‰©ä½™çš„é¡µè¡¨æœªæŒ‡å®šç‰©ç†é¡µ</span></span><br><span class="line">            <span class="built_in">releaseVirtualPages</span>(type, virtualAddress + i * PAGE_SIZE, count - i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> virtualAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹ä¹Ÿä¼šå‡ºç°æ²¡æœ‰äº’æ–¥è®¿é—®å¯¼è‡´çš„é—®é¢˜æ²¡æœ‰è§£å†³ã€‚</p>
<h3 id="Assignment-4-1"><a href="#Assignment-4-1" class="headerlink" title="Assignment 4"></a><strong>Assignment 4</strong></h3><p>æœ¬å®éªŒä¸­æˆ‘åœ¨winç¯å¢ƒä¸­æ¨¡æ‹ŸLRU</p>
<p><strong>LRUé¡µé¢ç½®æ¢</strong></p>
<p>æ ¸å¿ƒåŸç†æ˜¯åŸºäºâ€œæœ€è¿‘ä½¿ç”¨çš„æ•°æ®å°†æ¥è¢«ä½¿ç”¨çš„æ¦‚ç‡æ›´é«˜â€è¿™ä¸€å‡è®¾ï¼Œå³å¦‚æœä¸€ä¸ªæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå®ƒåœ¨ä¸ä¹…çš„å°†æ¥å¾ˆå¯èƒ½å†æ¬¡è¢«è®¿é—®ï¼›ç›¸åï¼Œå¦‚æœä¸€ä¸ªæ•°æ®å¾ˆé•¿æ—¶é—´æ²¡æœ‰è¢«è®¿é—®ï¼Œé‚£ä¹ˆå®ƒåœ¨å°†æ¥è¢«è®¿é—®çš„æ¦‚ç‡è¾ƒä½ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªtimeså˜é‡æ¥è®°å½•å¤šå°‘æ¬¡æ²¡æœ‰è¢«è®¿é—®è¿‡ï¼Œå–æœ€å¤§çš„æ·˜æ±°ã€‚</p>
<p>å®ç°ä»£ç è§å…³é”®ä»£ç </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">memory</span>&#123;</span><br><span class="line">	<span class="type">int</span> id;</span><br><span class="line">	<span class="type">int</span> times;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> num; <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> capacity; <span class="comment">// ç¼“å­˜ç©ºé—´</span></span><br><span class="line">    memory mem[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">LRUCache</span>(<span class="type">int</span> capacity)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;capacity = capacity;</span><br><span class="line">        num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;capacity;i++)&#123;</span><br><span class="line">        	mem[i].id = <span class="number">-1</span>;</span><br><span class="line">        	mem[i].times = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">tihuan</span><span class="params">(<span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> max = <span class="number">-1</span>;</span><br><span class="line">		<span class="type">int</span> max_id = <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(mem[i].times&gt;max)&#123;</span><br><span class="line">				max = mem[i].times;</span><br><span class="line">				max_id = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%dè¢«æ›¿æ¢ä¸º%d\n&quot;</span>,mem[max_id].id,k);</span><br><span class="line">		mem[max_id].id= k;</span><br><span class="line">		mem[max_id].times = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">find</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(mem[i].id== n)&#123;</span><br><span class="line">				flag = <span class="number">1</span>;</span><br><span class="line">				mem[i].times = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(<span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">    		mem[i].times++;</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="keyword">if</span>(!<span class="built_in">find</span>(k))&#123;</span><br><span class="line">    		<span class="keyword">if</span>(num&lt;capacity)&#123;</span><br><span class="line">    			mem[num].id=k;</span><br><span class="line">    			mem[num].times=<span class="number">0</span>;</span><br><span class="line">    			num++;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">tihuan</span>(k);</span><br><span class="line">			&#125;</span><br><span class="line">    	</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;id %d hit\n&quot;</span>,k);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;page id now:\n&quot;</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,mem[i].id);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> seq[<span class="number">10</span>]= &#123;<span class="number">7</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">    <span class="function">LRUCache <span class="title">cache1</span><span class="params">(<span class="number">3</span>)</span></span>; <span class="comment">// è®¾ç½®ç¼“å­˜å®¹é‡ä¸º3</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">		cache1.<span class="built_in">put</span>(seq[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-å…³é”®ä»£ç "><a href="#3-å…³é”®ä»£ç " class="headerlink" title="3. å…³é”®ä»£ç "></a>3. <strong>å…³é”®ä»£ç </strong></h2><p> Assignment1ä¸­åˆ†é…å†…å­˜ç”¨çš„æ˜¯å’ŒAssignment2ä¸€æ ·çš„æµ‹è¯•ä»£ç </p>
<p>Assignment2ä¸­first_fit:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">BitMap::allocate</span><span class="params">(<span class="type">const</span> <span class="type">int</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index, empty, start;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è¶Šè¿‡å·²ç»åˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="keyword">while</span> (index &lt; length &amp;&amp; <span class="built_in">get</span>(index))</span><br><span class="line">            ++index;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (index == length)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°1ä¸ªæœªåˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»indexå¼€å§‹çš„è¿ç»­countä¸ªèµ„æº</span></span><br><span class="line">        empty = <span class="number">0</span>;</span><br><span class="line">        start = index;</span><br><span class="line">        <span class="keyword">while</span> ((index &lt; length) &amp;&amp; (!<span class="built_in">get</span>(index)) &amp;&amp; (empty &lt; count))</span><br><span class="line">        &#123;</span><br><span class="line">            ++empty;</span><br><span class="line">            ++index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (empty == count)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">set</span>(start + i, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>best_fit:ä½¿ç”¨min_spaceå’Œmin_startè®°å½•å½“å‰æœ€å°ä¸”å¤§äºcountçš„æœ€å°ç©ºé—´ï¼Œå’Œå…¶å¯¹åº”çš„èµ·å§‹åœ°å€ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">BitMap::best_fit</span><span class="params">(<span class="type">const</span> <span class="type">int</span> count)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index, empty, start;</span><br><span class="line">    <span class="type">int</span> min_space = <span class="number">0xffffff</span>;</span><br><span class="line">    <span class="type">int</span> min_start = <span class="number">0</span>;</span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è¶Šè¿‡å·²ç»åˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="keyword">while</span> (index &lt; length &amp;&amp; <span class="built_in">get</span>(index))&#123;</span><br><span class="line">            ++index;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (index == length)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°1ä¸ªæœªåˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»indexå¼€å§‹çš„è¿ç»­countä¸ªèµ„æº</span></span><br><span class="line">        empty = <span class="number">0</span>;</span><br><span class="line">        start = index;</span><br><span class="line">        <span class="keyword">while</span> ((index &lt; length) &amp;&amp; (!<span class="built_in">get</span>(index)))</span><br><span class="line">        &#123;</span><br><span class="line">            ++empty;</span><br><span class="line">            ++index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(empty&gt;=count &amp;&amp; empty&lt;min_space)&#123;</span><br><span class="line">            min_space = empty;</span><br><span class="line">            min_start = start;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(min_space == <span class="number">0xffffff</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    start = min_start;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">set</span>(start + i, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> start;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>worst_fit:åˆ™ä¸best_fitç›¸å</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">BitMap::worst_fit</span><span class="params">(<span class="type">const</span> <span class="type">int</span> count)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index, empty, start;</span><br><span class="line">    <span class="type">int</span> max_space = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> max_start = <span class="number">0</span>;</span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è¶Šè¿‡å·²ç»åˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="keyword">while</span> (index &lt; length &amp;&amp; <span class="built_in">get</span>(index))&#123;</span><br><span class="line">            ++index;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (index == length)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°1ä¸ªæœªåˆ†é…çš„èµ„æº</span></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»indexå¼€å§‹çš„è¿ç»­countä¸ªèµ„æº</span></span><br><span class="line">        empty = <span class="number">0</span>;</span><br><span class="line">        start = index;</span><br><span class="line">        <span class="keyword">while</span> ((index &lt; length) &amp;&amp; (!<span class="built_in">get</span>(index)))</span><br><span class="line">        &#123;</span><br><span class="line">            ++empty;</span><br><span class="line">            ++index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(empty&gt;=count &amp;&amp; empty&gt;max_space)&#123;</span><br><span class="line">            max_space = empty;</span><br><span class="line">            max_start = start;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// å­˜åœ¨è¿ç»­çš„countä¸ªèµ„æº</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(max_space == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    start = max_start;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">set</span>(start + i, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Assignment4</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">memory</span>&#123;</span><br><span class="line">	<span class="type">int</span> id;</span><br><span class="line">	<span class="type">int</span> times;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> num; <span class="comment">// å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> capacity; <span class="comment">// ç¼“å­˜ç©ºé—´</span></span><br><span class="line">    memory mem[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">LRUCache</span>(<span class="type">int</span> capacity)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;capacity = capacity;</span><br><span class="line">        num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;capacity;i++)&#123;</span><br><span class="line">        	mem[i].id = <span class="number">-1</span>;</span><br><span class="line">        	mem[i].times = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">tihuan</span><span class="params">(<span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> max = <span class="number">-1</span>;</span><br><span class="line">		<span class="type">int</span> max_id = <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(mem[i].times&gt;max)&#123;</span><br><span class="line">				max = mem[i].times;</span><br><span class="line">				max_id = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%dè¢«æ›¿æ¢ä¸º%d\n&quot;</span>,mem[max_id].id,k);</span><br><span class="line">		mem[max_id].id= k;</span><br><span class="line">		mem[max_id].times = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">find</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(mem[i].id== n)&#123;</span><br><span class="line">				flag = <span class="number">1</span>;</span><br><span class="line">				mem[i].times = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(<span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">    		mem[i].times++;</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="keyword">if</span>(!<span class="built_in">find</span>(k))&#123;</span><br><span class="line">    		<span class="keyword">if</span>(num&lt;capacity)&#123;</span><br><span class="line">    			mem[num].id=k;</span><br><span class="line">    			mem[num].times=<span class="number">0</span>;</span><br><span class="line">    			num++;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">tihuan</span>(k);</span><br><span class="line">			&#125;</span><br><span class="line">  </span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;id %d hit\n&quot;</span>,k);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;page id now:\n&quot;</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,mem[i].id);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> seq[<span class="number">10</span>]= &#123;<span class="number">7</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">    <span class="function">LRUCache <span class="title">cache1</span><span class="params">(<span class="number">3</span>)</span></span>; <span class="comment">// è®¾ç½®ç¼“å­˜å®¹é‡ä¸º3</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">		cache1.<span class="built_in">put</span>(seq[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-å®éªŒç»“æœ"><a href="#4-å®éªŒç»“æœ" class="headerlink" title="4. å®éªŒç»“æœ"></a>4. <strong>å®éªŒç»“æœ</strong></h2><h2 id="Assignment-2-1"><a href="#Assignment-2-1" class="headerlink" title="Assignment 2"></a>Assignment 2</h2><p>åˆ†é…å››æ¬¡ï¼Œé‡Šæ”¾ä¸¤æ¬¡å†…å­˜åçš„å†…å­˜ç©ºé—´å¦‚å·¦å›¾æ‰€ç¤ºï¼Œå³ä¾§æ˜¯é‡‡ç”¨ä¸åŒæ–¹æ³•ç»§ç»­åˆ†é…ä¸¤æ¬¡ç©ºé—´åçš„ç»“æœ</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717131430906.png" alt="1717131430906"></p>
<p><img src="/2024/05/20/oslab7/oslab7/1717116874977.png" alt="1717116874977"></p>
<p>best_fit:</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717086633066.png" alt="1717086633066"></p>
<p>worst_fit</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717130935790.png" alt="1717130935790"></p>
<h3 id="Assignment-3-1"><a href="#Assignment-3-1" class="headerlink" title="Assignment 3"></a>Assignment 3</h3><p>æ²¡æœ‰å®ç°äº’æ–¥æœºåˆ¶æ—¶çš„é”™è¯¯ï¼šåˆ†é…åˆ°äº†åŒæ ·çš„è™šæ‹Ÿåœ°å€</p>
<p>æµ‹è¯•ç”¨ä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">memoryManager memoryManager;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">second_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *p2 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread2 %x\n&quot;</span>,p2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">third_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *p3 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread3 %x\n&quot;</span>,p3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">first_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pid1 = programManager.<span class="built_in">executeThread</span>(second_thread, <span class="literal">nullptr</span>, <span class="string">&quot;second thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> pid2 = programManager.<span class="built_in">executeThread</span>(third_thread, <span class="literal">nullptr</span>, <span class="string">&quot;third thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç¬¬1ä¸ªçº¿ç¨‹ä¸å¯ä»¥è¿”å›</span></span><br><span class="line">    <span class="comment">// stdio.moveCursor(0);</span></span><br><span class="line">    <span class="comment">// for (int i = 0; i &lt; 25 * 80; ++i)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     stdio.print(&#x27; &#x27;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// stdio.moveCursor(0);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p1 = (<span class="type">char</span> *)memoryManager.<span class="built_in">allocatePages</span>(AddressPoolType::KERNEL, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread1 %x\n&quot;</span>,p1);</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/20/oslab7/oslab7/1717376584481.png" alt="1717376584481"></p>
<p>æ”¹æ­£åçš„ç»“æœï¼š</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717348305387.png" alt="1717348305387"></p>
<h3 id="Assignment-4-2"><a href="#Assignment-4-2" class="headerlink" title="Assignment 4"></a>Assignment 4</h3><p>LRUç®—æ³•ï¼Œå¼•ç”¨ä¸²ä¸º7,0,1,2,0,3,0,4,2,3ï¼Œå¯ç”¨å¸§ä¸º3æ—¶çš„ç»“æœ</p>
<p><img src="/2024/05/20/oslab7/oslab7/1717347573550.png" alt="1717347573550"></p>
<h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. <strong>æ€»ç»“</strong></h2><p>   é€šè¿‡è¿™æ¬¡å®éªŒï¼Œæˆ‘æ›´åŠ æ·±åˆ»è®¤è¯†åˆ°å†…å­˜ç®¡ç†çš„é‡è¦æ„ä¹‰ï¼Œäº†è§£äº†äºŒçº§é¡µè¡¨çš„å®ç°æœºåˆ¶ã€‚äº†è§£äº†ä½å›¾ï¼Œå†…å­˜æ± ç­‰ç›¸å…³æ¦‚å¿µå’Œå®ç°ã€‚äº†è§£äº†è™šæ‹Ÿå†…å­˜ç®¡ç†æœºåˆ¶ï¼Œé¡µå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ï¼Œæœ€åå®ç°ç”¨FIFOç®—æ³•å®ç°äº†é¡µé¢ç½®æ¢ã€‚ç”¨LRUç®—æ³•åœ¨winç¯å¢ƒä¸‹æ¨¡æ‹Ÿäº†é¡µé¢ç½®æ¢çš„è¿‡ç¨‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/06/oslab6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/06/oslab6/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-05-06 11:08:57" itemprop="dateCreated datePublished" datetime="2024-05-06T11:08:57+08:00">2024-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-05-27 01:01:58" itemprop="dateModified" datetime="2024-05-27T01:01:58+08:00">2024-05-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!---
title:SYSU-2024æ“ä½œç³»ç»Ÿlab3å®éªŒæŠ¥å‘Š

date:2024-03-24 23:54:26

tags:os

comments:true

author:zyh
--->

<h1 id="å®éªŒåç§°-Lab6-å¹¶å‘ä¸é”æœºåˆ¶"><a href="#å®éªŒåç§°-Lab6-å¹¶å‘ä¸é”æœºåˆ¶" class="headerlink" title="å®éªŒåç§°:          Lab6 å¹¶å‘ä¸é”æœºåˆ¶"></a><strong>å®éªŒåç§°:          Lab6 å¹¶å‘ä¸é”æœºåˆ¶</strong></h1><p>å­¦ç”Ÿå§“å:                    åº„äº‘çš“</p>
<p>å­¦ç”Ÿå­¦å·:                   22336327</p>
<h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><h2 id="Assignment-1-ä»£ç å¤ç°é¢˜"><a href="#Assignment-1-ä»£ç å¤ç°é¢˜" class="headerlink" title="Assignment 1 ä»£ç å¤ç°é¢˜"></a><strong>Assignment 1 ä»£ç å¤ç°é¢˜</strong></h2><h3 id="1-1-ä»£ç å¤ç°"><a href="#1-1-ä»£ç å¤ç°" class="headerlink" title="1.1 ä»£ç å¤ç°"></a>1.1 ä»£ç å¤ç°</h3><p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†è‡ªæ—‹é”å’Œä¿¡å·é‡æœºåˆ¶ã€‚ç°åœ¨ï¼ŒåŒå­¦ä»¬éœ€è¦å¤ç°æ•™ç¨‹ä¸­çš„è‡ªæ—‹é”å’Œä¿¡å·é‡çš„å®ç°æ–¹æ³•ï¼Œåˆ†åˆ«ä½¿ç”¨äºŒè€…è§£å†³ä¸€ä¸ªåŒæ­¥äº’æ–¥é—®é¢˜ï¼Œå¦‚æ¶ˆå¤±çš„èŠå£«æ±‰å ¡é—®é¢˜ã€‚æœ€åï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<h3 id="1-2-é”æœºåˆ¶çš„å®ç°"><a href="#1-2-é”æœºåˆ¶çš„å®ç°" class="headerlink" title="1.2 é”æœºåˆ¶çš„å®ç°"></a>1.2 é”æœºåˆ¶çš„å®ç°</h3><p>æˆ‘ä»¬ä½¿ç”¨äº†åŸå­æŒ‡ä»¤ <code>xchg</code>æ¥å®ç°è‡ªæ—‹é”ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸æ˜¯å”¯ä¸€çš„ã€‚ä¾‹å¦‚ï¼Œx86æŒ‡ä»¤ä¸­æä¾›äº†å¦å¤–ä¸€ä¸ªåŸå­æŒ‡ä»¤ <code>bts</code>å’Œ <code>lock</code>å‰ç¼€ç­‰ï¼Œè¿™äº›æŒ‡ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°é”æœºåˆ¶ã€‚ç°åœ¨ï¼ŒåŒå­¦ä»¬éœ€è¦ç»“åˆè‡ªå·±æ‰€å­¦çš„çŸ¥è¯†ï¼Œå®ç°ä¸€ä¸ªä¸æœ¬æ•™ç¨‹çš„å®ç°æ–¹å¼ä¸å®Œå…¨ç›¸åŒçš„é”æœºåˆ¶ã€‚æœ€åï¼Œæµ‹è¯•ä½ å®ç°çš„é”æœºåˆ¶ï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<p>æç¤ºï¼šåœ¨ <code>asm_utils.asm</code>ä¸­å®ç°ä½ è‡ªå·±çš„åŸå­æ“ä½œ <code>your_asm_atomic_exchange</code>ï¼Œå¹¶åœ¨ <code>sync.cpp</code>ä¸­åšç›¸åº”ä¿®æ”¹ã€‚</p>
<h2 id="Assignment-2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#Assignment-2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="Assignment 2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"></a><strong>Assignment 2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</strong></h2><h3 id="2-1-Race-Condition"><a href="#2-1-Race-Condition" class="headerlink" title="2.1 Race Condition"></a>2.1 Race Condition</h3><p>åŒå­¦ä»¬å¯ä»¥ä»»å–ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼Œç„¶ååœ¨lab6çš„ä»£ç ç¯å¢ƒä¸‹åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥æ¨¡æ‹Ÿè¿™ä¸ªé—®é¢˜ã€‚åœ¨2.1ä¸­ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨ä»»ä½•åŒæ­¥äº’æ–¥çš„å·¥å…·ã€‚å› æ­¤ï¼Œè¿™äº›çº¿ç¨‹å¯èƒ½ä¼šäº§ç”Ÿå†²çªï¼Œè¿›è€Œæ— æ³•äº§ç”Ÿæˆ‘ä»¬é¢„æœŸçš„ç»“æœã€‚åŒå­¦ä»¬éœ€è¦å°†è¿™ä¸ªäº§ç”Ÿé”™è¯¯çš„åœºæ™¯å‘ˆç°å‡ºæ¥ï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<h3 id="2-2-ä¿¡å·é‡è§£å†³æ–¹æ³•"><a href="#2-2-ä¿¡å·é‡è§£å†³æ–¹æ³•" class="headerlink" title="2.2 ä¿¡å·é‡è§£å†³æ–¹æ³•"></a>2.2 ä¿¡å·é‡è§£å†³æ–¹æ³•</h3><p>ä½¿ç”¨ä¿¡å·é‡è§£å†³ä¸Šè¿°ä½ æ¨¡æ‹Ÿçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€‚å°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<p>æç¤ºï¼š</p>
<p>â‘ ç»å…¸çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜æœ‰è¯»è€…-å†™è€…é—®é¢˜ã€æœ‰ç•Œç¼“å†²åŒºé—®é¢˜ç­‰ï¼Œå¯ä»»å–ä¸€ä¸ªæ¥æ¨¡æ‹Ÿã€‚</p>
<p>â‘¡æ¨¡æ‹Ÿç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„æ­¥éª¤ï¼š1ã€åœ¨ä»£ç ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ä»£è¡¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚2ã€ç¼–å†™ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„çº¿ç¨‹å‡½æ•°ã€‚åœ¨è¿™äº›å‡½æ•°ä¸­ï¼Œæ ¹æ®é—®é¢˜çš„å…·ä½“åœºæ™¯å®ç°ç”Ÿäº§æ•°æ®å’Œæ¶ˆè´¹æ•°æ®çš„é€»è¾‘ã€‚3ã€åˆ›å»ºå¹¶å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹ã€‚è§‚å¯Ÿçº¿ç¨‹ä¹‹é—´çš„äº¤äº’å¹¶è®°å½•ç»“æœã€‚4ã€å±•ç¤ºæ²¡æœ‰ä½¿ç”¨åŒæ­¥äº’æ–¥å·¥å…·ï¼ˆå¦‚ä¿¡å·é‡ï¼‰æ—¶ï¼Œçº¿ç¨‹ä¹‹é—´å¯èƒ½äº§ç”Ÿçš„å†²çªã€‚5ã€ä½¿ç”¨ä¿¡å·é‡è§£å†³åŒæ­¥é—®é¢˜ï¼Œå¹¶å±•ç¤ºè§£å†³åçš„ç»“æœã€‚</p>
<p>â‘¢æ ·ä¾‹è§†é¢‘æ¨¡æ‹Ÿäº†è¯»è€…-å†™è€…é—®é¢˜çš„åœºæ™¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¨¡æ‹Ÿè¯»é”™è¯¯</span></span><br><span class="line"><span class="comment">//åˆ›å»ºçº¿ç¨‹è¯»ç¬¬1-4æ¡è®°å½•</span></span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readFirstQuote, <span class="literal">nullptr</span>, <span class="string">&quot;second thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readSecondQuote, <span class="literal">nullptr</span>, <span class="string">&quot;third thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readThirdQuote, <span class="literal">nullptr</span>, <span class="string">&quot;fourth thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readFourthQuote, <span class="literal">nullptr</span>, <span class="string">&quot;fifth thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//åˆ›å»ºçº¿ç¨‹ï¼Œä¿®æ”¹ç¬¬2æ¡å’Œç¬¬4æ¡è®°å½•ä¸ºè¾ƒé•¿å†…å®¹</span></span><br><span class="line"><span class="comment">//ç”±äºå†™æ—¶é—´è¾ƒé•¿ï¼Œå†™çº¿ç¨‹è¿è¡Œæ—¶é—´å¤§äºRRscheduleçš„time quantum</span></span><br><span class="line">programManager.<span class="built_in">executeThread</span>(writeSecondQuote, <span class="literal">nullptr</span>, <span class="string">&quot;sixth thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">programManager.<span class="built_in">executeThread</span>(writeFourthQuote, <span class="literal">nullptr</span>, <span class="string">&quot;seventh thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//åˆ›å»ºçº¿ç¨‹è¯»ç¬¬2æ¡å’Œç¬¬4æ¡è®°å½•</span></span><br><span class="line"><span class="comment">//å‘ç°æ²¡æœ‰è¯»åˆ°ä¿®æ”¹åçš„é¡¹ï¼Œè€Œæ˜¯è¾“å‡ºäº†åˆå§‹é¡¹</span></span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readSecondQuote, <span class="literal">nullptr</span>, <span class="string">&quot;eighth thread&quot;</span>, <span class="number">1</span>);</span><br><span class="line">programManager.<span class="built_in">executeThread</span>(readFourthQuote, <span class="literal">nullptr</span>, <span class="string">&quot;ninth thread&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>è€Œä½¿ç”¨ä¿¡å·é‡åï¼Œå¯ä»¥è¯»åˆ°ä¿®æ”¹åçš„é¡¹ã€‚</p>
<h2 id="Assignment-3-å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#Assignment-3-å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="Assignment 3 å“²å­¦å®¶å°±é¤é—®é¢˜"></a><strong>Assignment 3 å“²å­¦å®¶å°±é¤é—®é¢˜</strong></h2><p>å‡è®¾æœ‰ 5 ä¸ªå“²å­¦å®¶ï¼Œä»–ä»¬çš„ç”Ÿæ´»åªæ˜¯æ€è€ƒå’Œåƒé¥­ã€‚è¿™äº›å“²å­¦å®¶å…±ç”¨ä¸€ä¸ªåœ†æ¡Œï¼Œæ¯ä½éƒ½æœ‰ä¸€æŠŠæ¤…å­ã€‚åœ¨æ¡Œå­ä¸­å¤®æœ‰ä¸€ç¢—ç±³é¥­ï¼Œåœ¨æ¡Œå­ä¸Šæ”¾ç€ 5 æ ¹ç­·å­ã€‚</p>
<p><img src="https://gitee.com/qin_chu_yan/sysu-2024-spring-operating-system/raw/main/lab6/gallery/%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98.jpeg" alt="å“²å­¦å®¶å°±é¤é—®é¢˜"></p>
<p>å½“ä¸€ä½å“²å­¦å®¶æ€è€ƒæ—¶ï¼Œä»–ä¸å…¶ä»–åŒäº‹ä¸äº¤æµã€‚æ—¶è€Œï¼Œä»–ä¼šæ„Ÿåˆ°é¥¥é¥¿ï¼Œå¹¶è¯•å›¾æ‹¿èµ·ä¸ä»–ç›¸è¿‘çš„ä¸¤æ ¹ç­·å­ï¼ˆç­·å­åœ¨ä»–å’Œä»–çš„å·¦æˆ–å³é‚»å±…ä¹‹é—´ï¼‰ã€‚ä¸€ä¸ªå“²å­¦å®¶ä¸€æ¬¡åªèƒ½æ‹¿èµ·ä¸€æ ¹ç­·å­ã€‚æ˜¾ç„¶ï¼Œä»–ä¸èƒ½ä»å…¶ä»–å“²å­¦å®¶æ‰‹é‡Œæ‹¿èµ°ç­·å­ã€‚å½“ä¸€ä¸ªé¥¥é¥¿çš„å“²å­¦å®¶åŒæ—¶æ‹¥æœ‰ä¸¤æ ¹ç­·å­æ—¶ï¼Œä»–å°±èƒ½åƒã€‚åœ¨åƒå®Œåï¼Œä»–ä¼šæ”¾ä¸‹ä¸¤æ ¹ç­·å­ï¼Œå¹¶å¼€å§‹æ€è€ƒã€‚</p>
<h3 id="3-1-åˆæ­¥è§£å†³æ–¹æ³•"><a href="#3-1-åˆæ­¥è§£å†³æ–¹æ³•" class="headerlink" title="3.1 åˆæ­¥è§£å†³æ–¹æ³•"></a>3.1 åˆæ­¥è§£å†³æ–¹æ³•</h3><p>åŒå­¦ä»¬éœ€è¦åœ¨æœ¬æ•™ç¨‹çš„ä»£ç ç¯å¢ƒä¸‹ï¼Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥æ¨¡æ‹Ÿå“²å­¦å®¶å°±é¤çš„åœºæ™¯ã€‚ç„¶åï¼ŒåŒå­¦ä»¬éœ€è¦ç»“åˆä¿¡å·é‡æ¥å®ç°ç†è®ºè¯¾æ•™æä¸­ç»™å‡ºçš„å…³äºå“²å­¦å®¶å°±é¤é—®é¢˜çš„æ–¹æ³•ã€‚æœ€åï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<p>è¯¥æ–¹æ¡ˆå¯èƒ½å¯¼è‡´æ­»é”ï¼Œè¯·ä¸¾ä¾‹å‡ºç°æ­»é”çš„åœºæ™¯å’ŒåŸå› ï¼Œå¹¶æå‡ºä¸€ç§è§£å†³æ­»é”çš„æ–¹æ¡ˆã€‚</p>
<h3 id="3-2-æ­»é”è§£å†³æ–¹æ³•ï¼ˆé€‰åšï¼‰"><a href="#3-2-æ­»é”è§£å†³æ–¹æ³•ï¼ˆé€‰åšï¼‰" class="headerlink" title="3.2 æ­»é”è§£å†³æ–¹æ³•ï¼ˆé€‰åšï¼‰"></a>3.2 æ­»é”è§£å†³æ–¹æ³•ï¼ˆé€‰åšï¼‰</h3><p>è™½ç„¶3.1çš„è§£å†³æ–¹æ¡ˆä¿è¯ä¸¤ä¸ªé‚»å±…ä¸èƒ½åŒæ—¶è¿›é£Ÿï¼Œä½†æ˜¯å®ƒå¯èƒ½å¯¼è‡´æ­»é”ã€‚ç°åœ¨ï¼ŒåŒå­¦ä»¬éœ€è¦æƒ³åŠæ³•å°†æ­»é”çš„åœºæ™¯æ¼”ç¤ºå‡ºæ¥ã€‚æå‡ºä¸€ç§è§£å†³æ­»é”çš„æ–¹æ³•å¹¶å®ç°ã€‚æœ€åï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<p>â‘ ä¸ºæ¼”ç¤ºæ­»é”åœºæ™¯ï¼Œå¯ä»¥åœ¨å“²å­¦å®¶è¿›é£Ÿçš„çº¿ç¨‹ä¸­æ·»åŠ ç­‰å¾…æ—¶é—´ï¼Œä½¿å“²å­¦å®¶ä»¬çš„æ“ä½œæ›´æ¥è¿‘äºåŒæ—¶è¿›è¡Œã€‚</p>
<p>â‘¡æ ·ä¾‹è§†é¢‘æ¼”ç¤ºäº†ç­‰å¾…æ—¶é—´è¾ƒå°‘â€”â€”æ­£å¸¸ã€ç­‰å¾…æ—¶é—´è¾ƒé•¿â€”â€”å‡ºç°æ­»é”ã€‚</p>
<h2 id="2-å®éªŒè¿‡ç¨‹"><a href="#2-å®éªŒè¿‡ç¨‹" class="headerlink" title="2. å®éªŒè¿‡ç¨‹"></a>2. <strong>å®éªŒè¿‡ç¨‹</strong></h2><h3 id="Assignment1"><a href="#Assignment1" class="headerlink" title="Assignment1"></a><strong>Assignment1</strong></h3><h4 id="1-1-1è‡ªæ—‹é”å®ç°æ–¹æ³•"><a href="#1-1-1è‡ªæ—‹é”å®ç°æ–¹æ³•" class="headerlink" title="1.1.1è‡ªæ—‹é”å®ç°æ–¹æ³•"></a>1.1.1è‡ªæ—‹é”å®ç°æ–¹æ³•</h4><p>spinlockä¸­privateå˜é‡æ˜¯ä¸¤ä¸ªçº¿ç¨‹æœ‰å…¬ç”¨çš„å˜é‡bolt,åˆå§‹åŒ–ä¸º0</p>
<ul>
<li>å±€éƒ¨å˜é‡keyåˆå§‹åŒ–ä¸º1</li>
<li>å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œå°†boltå’Œkeyäº¤æ¢ï¼Œboltä¸º1ï¼Œkeyä¸º0ï¼Œè·³å‡ºå¾ªç¯è¿›å…¥ä¸´ç•ŒåŒºã€‚</li>
<li>æ­¤æ—¶å…¶ä»–çº¿ç¨‹å¦‚æœæƒ³è¦è¿›å…¥ä¸´ç•ŒåŒºï¼Œå®ƒçš„keyåˆå§‹åŒ–ä¸º1ï¼Œboltä¸º1ï¼Œäº¤æ¢åkeyä»ç„¶ä¸º1ï¼Œå¾ªç¯ç­‰å¾…ï¼ˆè‡ªæ—‹ï¼‰</li>
</ul>
<p>äº¤æ¢çš„è¿‡ç¨‹è§å…³é”®ä»£ç éƒ¨åˆ†ã€‚</p>
<p>è§‚å¯Ÿæ˜¯å¦è§£å†³äº†æ¶ˆå¤±çš„èŠå£«æ±‰å ¡é—®é¢˜</p>
<h4 id="1-1-1ä¿¡å·é‡å®ç°æ–¹æ³•"><a href="#1-1-1ä¿¡å·é‡å®ç°æ–¹æ³•" class="headerlink" title="1.1.1ä¿¡å·é‡å®ç°æ–¹æ³•"></a>1.1.1ä¿¡å·é‡å®ç°æ–¹æ³•</h4><p>åœ¨include&#x2F;sync.hä¸‹å®šä¹‰ä¿¡å·é‡Semaphoreç±»ã€‚ç±»ä¸­å˜é‡couter.è¡¨ç¤ºå·²æœ‰èµ„æºæ•°</p>
<ul>
<li>P():åªè¦counter&gt;0åˆ™æŠŠcounter-&#x3D;1;å¦‚æœcountyå·²ç»&#x3D;0åˆ™æŠŠå½“å‰çº¿ç¨‹æ”¾è¿›ç­‰å¾…é˜Ÿåˆ—ï¼Œå°†çº¿ç¨‹çŠ¶æ€ç½®ä¸ºblockecd</li>
<li>V():counter++,è·å–ç­‰å¾…é˜Ÿåˆ—é˜Ÿé¦–å…ƒç´ å¹¶å”¤é†’ã€‚</li>
</ul>
<p>åœ¨åœ¨first_threadé‡Œå°†semaphore åˆå§‹åŒ–ä¸º1ï¼Œç„¶ååœ¨è°ƒç”¨ <code>mother</code>å‡½æ•°åœ¨<strong>mycheese_burger+&#x3D;10</strong> å‰P,åœ¨printæ±‰å ¡å‰©ä½™é‡ä¹‹åVé˜²æ­¢åœ¨è¿™æ®µæ—¶é—´å†…æ±‰å ¡è¢«å·åƒã€‚</p>
<h4 id="1-2-é”æœºåˆ¶çš„å®ç°-1"><a href="#1-2-é”æœºåˆ¶çš„å®ç°-1" class="headerlink" title="1.2 é”æœºåˆ¶çš„å®ç°"></a>1.2 é”æœºåˆ¶çš„å®ç°</h4><p>btsæŒ‡ä»¤(bit test and set)ä½œç”¨å°±æ˜¯è®¾ç½®å†…å®¹ä¸­çš„ä¸€ä¸ªä½ä¸º1, ä¼šé¦–å…ˆåˆ¤æ–­è¯¥ä½æ˜¯å¦å·²ç»ä¸º1ï¼Œæ˜¯å°±è¿”å›1ï¼Œä¸æ˜¯åˆ™ç½®ä¸º1,ç„¶åè¿”å›0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">my_spinlock_lock:</span><br><span class="line">    push ebp</span><br><span class="line">    mov ebp, esp</span><br><span class="line">    pushad</span><br><span class="line">.loop:</span><br><span class="line">    mov ebx, [ebp + 4 * 2]</span><br><span class="line">    mov edx, 0</span><br><span class="line">    lock bts dword [ebx], edx;test and set ç¬¬é›¶ä½ï¼›è‹¥ä¸º0åˆ™å°†å…¶ç½®1ï¼Œå¹¶å°†åŸæ¥çš„å€¼ä¿å­˜è¿›CF,</span><br><span class="line">    ;ç¬¬é›¶ä½è‹¥ä¸º1åˆ™ CF = 1</span><br><span class="line"></span><br><span class="line">    jc .loop ;CFä¸º1åˆ™è·³è½¬</span><br><span class="line"></span><br><span class="line">    popad</span><br><span class="line">    pop ebp</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿè¿™æ®µä¸Šé”çš„å‡½æ•°ï¼Œæˆ‘ä»¬ <code>.loop</code>å¾ªç¯ä¸­ï¼Œ<code>[ebx]</code>çš„å€¼æ˜¯ä¼ è¿›å‡½æ•°çš„å‚æ•°ï¼Œå³ <code>bolt</code>å˜é‡ã€‚<code>bts</code>è¯­å¥çš„ä½œç”¨æ˜¯é¦–å…ˆåˆ¤æ–­ <code>bolt</code>æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯çš„è¯å°±å°†å…¶æ”¹ä¸º1ï¼Œå°†CFå¯„å­˜å™¨ç½®0ï¼Œå¦‚æœæ˜¯1åˆ™boltä¸å˜ï¼ŒCF &#x3D; 1</p>
<p>è¿™æ®µä»£ç èƒ½å®ç°äº’æ–¥è®¿é—®çš„åŸå› æ˜¯ï¼šåˆå§‹åŒ–boltä¸º0ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶ä¼šå°†boltæ”¹ä¸º1ï¼Œå¦‚æœæ­¤æ—¶è¢«å¦ä¸€ä¸ªè¿›ç¨‹æŠ¢å çš„è¯ï¼Œboltå°±ä»ç„¶ä¸º1ï¼Œå¾ªç¯ç­‰å¾…ã€‚ç›´åˆ°åŸè¿›ç¨‹è°ƒç”¨ <code>unlock</code>å‡½æ•°å°†boltç½®ä¸º0ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹æ‰èƒ½è·³å‡º.loopå¾ªç¯ï¼Œè¿›å…¥ä¸´ç•ŒåŒºåŸŸã€‚btsæŒ‡ä»¤ä¿è¯äº†æ“ä½œçš„åŸå­æ€§ã€‚</p>
<h3 id="Assignment2"><a href="#Assignment2" class="headerlink" title="Assignment2"></a><strong>Assignment2</strong></h3><h4 id="Assignment-2-1"><a href="#Assignment-2-1" class="headerlink" title="Assignment 2.1"></a>Assignment 2.1</h4><p>ä¸€ä¸ªé”™è¯¯åœºæ™¯ï¼š</p>
<p>è§‚å¯Ÿä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">(<span class="type">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(cnt &lt; MAX_BUFFER_SIZE)&#123;</span><br><span class="line">            <span class="type">int</span> delay = <span class="number">0xffffff</span>;</span><br><span class="line">            <span class="keyword">while</span>(delay)&#123;</span><br><span class="line">                delay--;</span><br><span class="line">            &#125;</span><br><span class="line">            buffer[cnt] = <span class="number">1</span>;</span><br><span class="line">            cnt++;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;produced an item, cnt = %d\n&quot;</span>,cnt);</span><br><span class="line">            <span class="keyword">if</span>(cnt &gt; MAX_BUFFER_SIZE)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;overflow\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰å®ç°PVæ“ä½œæ—¶çš„é”™è¯¯åœºæ™¯ï¼š</p>
<p>å¯ä»¥çœ‹åˆ°å½“å‰bufferæ•°ç»„ä¸­çš„å…ƒç´ å·²ç»æœ‰MAX_SIZE-1ä¸ªæ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹åˆ¤æ–­if(cnt&lt;MAX_SIZE)ç¬¦åˆæ¡ä»¶è¿›å…¥ï¼Œåœ¨cnt++ä¹‹å‰è¢«è°ƒåº¦ä¸‹å¤„ç†å™¨ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦ä¸Šå¤„ç†å™¨ï¼ŒåŒæ ·æ»¡è¶³if(cnt&lt;MAX_SIZE)çš„æ¡ä»¶ï¼Œè¿›å…¥ä¸´ç•ŒåŒºåŸŸï¼Œcnt++ã€‚</p>
<p>ä¹‹å‰è¢«è°ƒåº¦ä¸‹æ¥çš„è¿›ç¨‹é‡æ–°è¿›å…¥runningçŠ¶æ€æ—¶cntä¹Ÿ++,å¯¼è‡´cnt&gt;MAX_SIZE,å‡ºç°æº¢å‡ºã€‚</p>
<p>underflowçš„æƒ…å†µä»¥æ­¤ç±»æ¨ã€‚</p>
<h4 id="Assignment-2-2"><a href="#Assignment-2-2" class="headerlink" title="Assignment 2.2"></a>Assignment 2.2</h4><p>ä¿¡å·é‡è§£å†³æ–¹æ¡ˆï¼š</p>
<p>ä¸‰ä¸ªä¿¡å·é‡</p>
<ul>
<li><code>empty_slots</code>ï¼šåˆå§‹åŒ–å€¼ä¸ºMAX_SIZE</li>
<li><code>full_slots</code>: åˆå§‹åŒ–å€¼ä¸º0</li>
<li><code>mutex</code>:åˆå§‹åŒ–å€¼ä¸º1</li>
</ul>
<p>æ¯æ¬¡è¿›å…¥ä¸´ç•ŒåŒºä¹‹å‰ï¼Œ<code>empty_slots.P()</code>ä½¿empty_slots.counterâ€“ï¼Œ mutex.P()ä¿è¯äº’æ–¥è®¿é—®ã€‚å¦‚æœä¸åŠ  <code>mutex.P()</code>çš„è¯ï¼Œå¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯ï¼šMAX_SIZEå¤§äºç­‰äº2æ—¶ï¼Œé‚£ä¹ˆå°±å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥productçš„æ ¸å¿ƒä»£ç æ®µï¼Œäº§ç”Ÿå¸¸è§çš„èµ„æºå…±äº«é—®é¢˜ã€‚</p>
<p>ä»ä¸´ç•ŒåŒºå‡ºæ¥æ—¶ï¼Œè¦æŠŠfull_slots++ï¼Œmutexè§£é”ã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼š<code>empty_slots.P()</code>å’Œ <code>mutex.P()</code>ä¸èƒ½äº¤æ¢é¡ºåºï¼Œè¿™æ˜¯å› ä¸ºï¼Œå¦‚æœäº¤æ¢é¡ºåºï¼Œbufferä¸ºæ»¡æ—¶ä¼šæ­»é”ï¼Œå› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥äº†ä¸´ç•ŒåŒºï¼Œmutexä¸Šé”ï¼Œempty_slots-&gt;counter&#x3D;MAX_SIZE-1,å¾ªç¯ç­‰å¾…ï¼Œæ­¤æ—¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºå·²ç»ä¸Šé”çš„ç¼˜æ•…æ— æ³•è¿›è¡Œç”Ÿäº§çš„.</p>
<p>åŒç† <code>full_slots.P()</code>å’Œ <code>mutex.P()</code>ä¹Ÿä¸èƒ½äº¤æ¢é¡ºåº</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">empty_slots.<span class="built_in">P</span>();</span><br><span class="line">mutex.<span class="built_in">P</span>();</span><br><span class="line">buffer[cnt] = <span class="number">1</span>;</span><br><span class="line">cnt++;</span><br><span class="line">mutex.<span class="built_in">V</span>();</span><br><span class="line">full_slots.<span class="built_in">V</span>();</span><br></pre></td></tr></table></figure>

<h3 id="Assignment-3"><a href="#Assignment-3" class="headerlink" title="Assignment 3"></a><strong>Assignment 3</strong></h3><p>3.1</p>
<p>äº”ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿäº”ä¸ªå“²å­¦å®¶ï¼Œè®¾ç½®å®¹é‡ä¸º5çš„ä¿¡å·é‡æ•°ç»„æ¨¡æ‹Ÿç­·å­ã€‚å¯¹å“²å­¦å®¶æŒ‰é¡ºåºä» <code>0ï½4</code>ç¼–å·ï¼Œå“²å­¦å®¶iå·¦è¾¹çš„ç­·å­çš„ç¼–å·ä¸ºiï¼Œå“²å­¦å®¶å³è¾¹çš„ç­·å­çš„ç¼–å·ä¸º <code>(i+l)%5</code>ã€‚</p>
<p>ç®—æ³•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼šå½“äº”ä¸ªå“²å­¦å®¶éƒ½æƒ³è¦è¿›é¤ï¼Œåˆ†åˆ«æ‹¿èµ·ä»–ä»¬å·¦è¾¹ç­·å­çš„æ—¶å€™ï¼ˆéƒ½æ°å¥½æ‰§è¡Œå®Œ <code>chopstick[i].wait();</code>)ç­·å­å·²ç»è¢«æ‹¿å…‰äº†ï¼Œç­‰åˆ°ä»–ä»¬å†æƒ³æ‹¿å³è¾¹çš„ç­·å­çš„æ—¶å€™ï¼ˆæ‰§è¡Œ <code>wait(chopstick[(i+l)%5].wait()</code>)å°±å…¨è¢«é˜»å¡äº†ï¼Œè¿™å°±å‡ºç°äº†æ­»é”ã€‚</p>
<p>3.2</p>
<ul>
<li>solution1</li>
</ul>
<p>ä¸€å…±æœ‰äº”ä¸ªå“²å­¦å®¶ï¼Œåªå…è®¸å››ä½å“²å­¦å®¶åŒæ—¶å¤„äºæ‹¿èµ·ç­·å­çš„çŠ¶æ€ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æœ‰äº”ä¸ªå“²å­¦å®¶å…¨éƒ½æ‹¿èµ·å·¦è¾¹çš„ç­·å­å¯¼è‡´æ­»é”æˆ–è€…éƒ½æ‹¿èµ·å³è¾¹çš„ç­·å­çš„æƒ…å½¢ã€‚</p>
<p>éœ€è¦è®¾ç½®ä¸€ä¸ªä¿¡å·é‡num,åˆå§‹åŒ–ä¸º4ï¼Œåœ¨æ‹¿èµ·ç­·å­å‰num.P(),æ”¾ä¸‹ç­·å­ä¹‹ånum.V()</p>
<ul>
<li>solution2</li>
</ul>
<p>è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸ªåŠæ³•æ˜¯åœ¨æ‹¿èµ·ç­·å­å‰å…ˆåˆ¤æ–­å·¦å³ä¸¤ä¸ªç­·å­æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨æ‰èƒ½æ‹¿ï¼Œè€Œä¸”æ˜¯åŒæ—¶æ‹¿ï¼Œè¿™æ ·ä¸ç›¸é‚»çš„å“²å­¦å®¶å°±å¯ä»¥åƒä¸Šé¥­ï¼Œä¸ä¼šé€ æˆæ­»é”ã€‚</p>
<p>å®ç°è¿™ä¸ªæ€è·¯åˆæœ‰ä¸¤ç§å…·ä½“çš„ç­–ç•¥</p>
<ul>
<li><ul>
<li>i æ¡ä»¶ <code>(chopsticks[lhs].getcounter() &amp;&amp;chopsticks[rhs].getcounter())</code>æˆç«‹æ‰æŠŠå·¦è¾¹å’Œå³è¾¹çš„ç­·å­è¿›è¡ŒPæ“ä½œã€‚</li>
<li>iié‡‡ç”¨å¦ä¸€ä¸ªä¿¡å·é‡ <code>mutex</code>è¿›è¡Œæ§åˆ¶ï¼Œä¿è¯æ‹¿èµ·å·¦å³æ‰‹çš„ç­·å­è¿™ä¸€æ“ä½œå˜ä¸ºåŸå­çš„ï¼Œä¸èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œæ‹¿èµ·å·¦å³æ‰‹ç­·å­çš„æ“ä½œ</li>
</ul>
</li>
</ul>
<h2 id="3-å…³é”®ä»£ç "><a href="#3-å…³é”®ä»£ç " class="headerlink" title="3. å…³é”®ä»£ç "></a>3. <strong>å…³é”®ä»£ç </strong></h2><h3 id="Assignment-1"><a href="#Assignment-1" class="headerlink" title="Assignment 1"></a><strong>Assignment 1</strong></h3><p>1.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">; void asm_atomic_exchange(uint32 *register, uint32 *memeory);</span><br><span class="line">asm_atomic_exchange:</span><br><span class="line">    push ebp</span><br><span class="line">    mov ebp, esp</span><br><span class="line">    pushad</span><br><span class="line"></span><br><span class="line">    mov ebx, [ebp + 4 * 2] ; register</span><br><span class="line">    mov eax, [ebx]      ; å–å‡ºregisteræŒ‡å‘çš„å˜é‡çš„å€¼</span><br><span class="line">    mov ebx, [ebp + 4 * 3] ; memory</span><br><span class="line">    xchg [ebx], eax      ; åŸå­äº¤æ¢æŒ‡ä»¤</span><br><span class="line">    mov ebx, [ebp + 4 * 2] ; memory</span><br><span class="line">    mov [ebx], eax      ; å°†memoryæŒ‡å‘çš„å€¼èµ‹å€¼ç»™registeræŒ‡å‘çš„å˜é‡</span><br><span class="line"></span><br><span class="line">    popad</span><br><span class="line">    pop ebp</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>ä¿¡å·é‡è§£å†³æ–¹æ¡ˆï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Semaphore semaphore;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cheese_burger;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">a_mother</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">P</span>();</span><br><span class="line">    <span class="type">int</span> delay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mother: start to make cheese burger, there are %d cheese burger now\n&quot;</span>, cheese_burger);</span><br><span class="line">    <span class="comment">// make 10 cheese_burger</span></span><br><span class="line">    cheese_burger += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mother: oh, I have to hang clothes out.\n&quot;</span>);</span><br><span class="line">    <span class="comment">// hanging clothes out</span></span><br><span class="line">    delay = <span class="number">0xfffffff</span>;</span><br><span class="line">    <span class="keyword">while</span> (delay)</span><br><span class="line">        --delay;</span><br><span class="line">    <span class="comment">// done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mother: Oh, Jesus! There are %d cheese burgers\n&quot;</span>, cheese_burger);</span><br><span class="line">    semaphore.<span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">a_naughty_boy</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    semaphore.<span class="built_in">P</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;boy   : Look what I found!\n&quot;</span>);</span><br><span class="line">    <span class="comment">// eat all cheese_burgers out secretly</span></span><br><span class="line">    cheese_burger -= <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// run away as fast as possible</span></span><br><span class="line">    semaphore.<span class="built_in">V</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">my_spinlock_lock:</span><br><span class="line">    push ebp</span><br><span class="line">    mov ebp, esp</span><br><span class="line">    pushad</span><br><span class="line">.loop:</span><br><span class="line">    mov ebx, [ebp + 4 * 2]</span><br><span class="line">    mov eax, 1</span><br><span class="line">    mov edx, 0</span><br><span class="line">    lock bts dword [ebx], edx;test and set ç¬¬é›¶ä½ï¼›è‹¥ä¸º0åˆ™å°†å…¶ç½®1ï¼Œå¹¶å°†åŸæ¥çš„å€¼ä¿å­˜è¿›CF,</span><br><span class="line">    ;ç¬¬é›¶ä½è‹¥ä¸º1åˆ™ CF = 1</span><br><span class="line"></span><br><span class="line">    jc .loop ;CFä¸º1åˆ™è·³è½¬</span><br><span class="line"></span><br><span class="line">    popad</span><br><span class="line">    pop ebp</span><br><span class="line">    ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Assignment2-1"><a href="#Assignment2-1" class="headerlink" title="Assignment2"></a><strong>Assignment2</strong></h3><p>2.1</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> MAX_BUFFER_SIZE 1</span></span><br><span class="line"><span class="type">int</span> buffer[MAX_BUFFER_SIZE];</span><br><span class="line"><span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">(<span class="type">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(cnt &lt; MAX_BUFFER_SIZE)&#123;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> delay = <span class="number">0xffffff</span>;</span><br><span class="line">            <span class="keyword">while</span>(delay)&#123;</span><br><span class="line">                delay--;</span><br><span class="line">            &#125;</span><br><span class="line">            buffer[cnt] = <span class="number">1</span>;</span><br><span class="line">            cnt++;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;produced an item, cnt = %d\n&quot;</span>,cnt);</span><br><span class="line">            <span class="keyword">if</span>(cnt &gt; MAX_BUFFER_SIZE)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;overflow\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">consumer</span><span class="params">(<span class="type">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(cnt &gt; <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> delay = <span class="number">0xffffff</span>;</span><br><span class="line">            <span class="keyword">while</span>(delay)&#123;</span><br><span class="line">                delay--;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cnt--;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;consumerd an item, cnt = %d\n&quot;</span>,cnt);</span><br><span class="line">            <span class="keyword">if</span>(cnt&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;underflow\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            buffer[cnt] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.2</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> MAX_BUFFER_SIZE 1</span></span><br><span class="line"><span class="type">int</span> buffer[MAX_BUFFER_SIZE];</span><br><span class="line"><span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">(<span class="type">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">//if(cnt &lt; MAX_BUFFER_SIZE)&#123;</span></span><br><span class="line">            <span class="type">int</span> delay = <span class="number">0xffffff</span>;</span><br><span class="line">            <span class="keyword">while</span>(delay)&#123;</span><br><span class="line">                delay--;</span><br><span class="line">            &#125;</span><br><span class="line">            empty_slots.<span class="built_in">P</span>();</span><br><span class="line">            mutex.<span class="built_in">P</span>();</span><br><span class="line">            buffer[cnt] = <span class="number">1</span>;</span><br><span class="line">            cnt++;</span><br><span class="line">            mutex.<span class="built_in">V</span>();</span><br><span class="line">            full_slots.<span class="built_in">V</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;produced an item, cnt = %d\n&quot;</span>,cnt);</span><br><span class="line">            <span class="keyword">if</span>(cnt &gt; MAX_BUFFER_SIZE)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;overflow\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">consumer</span><span class="params">(<span class="type">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">//if(cnt &gt; 0)&#123;</span></span><br><span class="line">            full_slots.<span class="built_in">P</span>();<span class="comment">// ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºé—²ä½ç½®ï¼Œ åœ¨ä½¿ç”¨PVæ“ä½œæ—¶ï¼Œæ¡ä»¶å˜é‡éœ€è¦åœ¨äº’æ–¥é”ä¹‹å‰</span></span><br><span class="line">            mutex.<span class="built_in">P</span>(); <span class="comment">// ä¿è¯åœ¨productæ—¶ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è®¿é—®ç¼“å†²åŒº</span></span><br><span class="line">            <span class="type">int</span> delay = <span class="number">0xffffff</span>;</span><br><span class="line">            <span class="keyword">while</span>(delay)&#123;</span><br><span class="line">                delay--;</span><br><span class="line">            &#125;</span><br><span class="line">            cnt--;</span><br><span class="line">            buffer[cnt] = <span class="number">0</span>;</span><br><span class="line">            mutex.<span class="built_in">V</span>();</span><br><span class="line">            empty_slots.<span class="built_in">V</span>(); <span class="comment">// é€šçŸ¥consumerç¼“å†²åŒºæœ‰èµ„æºå¯ä»¥å–èµ°</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;consumerd an item, cnt = %d\n&quot;</span>,cnt);</span><br><span class="line">            <span class="keyword">if</span>(cnt&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;underflow\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Assignment3"><a href="#Assignment3" class="headerlink" title="Assignment3"></a><strong>Assignment3</strong></h3><p>3.2-solution1</p>
<p>numåˆå§‹åŒ–ä¸º4ï¼Œåœ¨æ‹¿èµ·ç­·å­å‰num.P(),æ”¾ä¸‹ç­·å­ä¹‹ånum.V()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Semaphore eaters;</span><br><span class="line"><span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">philosopher</span><span class="params">(<span class="type">int</span> id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> delay =<span class="number">0xffffff</span>;</span><br><span class="line">        num.<span class="built_in">P</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;philosopher%d is hungry    &quot;</span>,id);</span><br><span class="line">  </span><br><span class="line">        chopsticks[id].<span class="built_in">P</span>();</span><br><span class="line">        <span class="keyword">while</span>(delay&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            delay--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//printf(&quot;philosopher%d picked up chopstick%d\n&quot;,id,id);</span></span><br><span class="line">        chopsticks[(id+<span class="number">1</span>)%MAX_SIZE].<span class="built_in">P</span>();</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//printf(&quot;philosopher%d picked up chopstick%d\n&quot;,id,(id+1)%MAX_SIZE);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;philosopher%d is eating\n&quot;</span>,id);</span><br><span class="line">        chopsticks[(id+<span class="number">1</span>)%MAX_SIZE].<span class="built_in">V</span>();</span><br><span class="line">        <span class="comment">//printf(&quot;philosopher%d lowered chopstick%d\n&quot;,id,id);</span></span><br><span class="line">        chopsticks[id].<span class="built_in">V</span>();</span><br><span class="line">        num.<span class="built_in">V</span>();</span><br><span class="line">        <span class="comment">//printf(&quot;philosopher%d lowered chopstick%d\n&quot;,id,(id+1)%MAX_SIZE);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.2-solution2</p>
<p>mutex-&gt;counteråˆå§‹åŒ–ä¸º1ï¼Œä¿è¯ä¸€ä¸ªå“²å­¦å®¶å·¦å³ä¸¤æ ¹ç­·å­éƒ½ä¼šè¢«æ‹¿èµ·</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mutex.<span class="built_in">P</span>();</span><br><span class="line">       chopsticks[id].<span class="built_in">P</span>();</span><br><span class="line">       <span class="keyword">while</span>(delay&gt;<span class="number">0</span>)&#123;</span><br><span class="line">           delay--;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//printf(&quot;philosopher%d picked up chopstick%d\n&quot;,id,id);</span></span><br><span class="line">       chopsticks[(id+<span class="number">1</span>)%MAX_SIZE].<span class="built_in">P</span>();</span><br><span class="line">       mutex.<span class="built_in">V</span>();</span><br></pre></td></tr></table></figure>

<h2 id="4-å®éªŒç»“æœ"><a href="#4-å®éªŒç»“æœ" class="headerlink" title="4. å®éªŒç»“æœ"></a>4. <strong>å®éªŒç»“æœ</strong></h2><h3 id="Assignment1-ä»£ç å¤ç°é¢˜"><a href="#Assignment1-ä»£ç å¤ç°é¢˜" class="headerlink" title="Assignment1 ä»£ç å¤ç°é¢˜"></a><strong>Assignment1 ä»£ç å¤ç°é¢˜</strong></h3><p>1.1.1ä½¿ç”¨è‡ªæ—‹é”è§£å†³æ¶ˆå¤±çš„èŠå£«æ±‰å ¡é—®é¢˜</p>
<p>1.1.2ä½¿ç”¨ä¿¡å·é‡è§£å†³æ¶ˆå¤±çš„èŠå£«æ±‰å ¡é—®é¢˜</p>
<p><img src="/2024/05/06/oslab6/oslab6/1714983997122.png" alt="1714983997122"></p>
<p>1.2ä½¿ç”¨btså®ç°è‡ªæ—‹é”</p>
<p><img src="/2024/05/06/oslab6/oslab6/1716042645677.png" alt="1716042645677"></p>
<h3 id="Assignment2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#Assignment2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="Assignment2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"></a><strong>Assignment2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</strong></h3><p>2.1Race Condition</p>
<p><img src="/2024/05/06/oslab6/oslab6/1715744966610.png" alt="1715744966610"></p>
<p>2.2é‡‡ç”¨ä¿¡å·é‡çš„è§£å†³æ–¹æ¡ˆMAX_SIZE &#x3D; 1æ—¶</p>
<p><img src="/2024/05/06/oslab6/oslab6/1716042964914.png" alt="1716042964914"></p>
<h3 id="Assignment3-å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#Assignment3-å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="Assignment3 å“²å­¦å®¶å°±é¤é—®é¢˜"></a><strong>Assignment3 å“²å­¦å®¶å°±é¤é—®é¢˜</strong></h3><p>å‡ºç°æ­»é”æƒ…å†µï¼š</p>
<p><img src="/2024/05/06/oslab6/oslab6/1715774700068.png" alt="1715774700068"></p>
<p>é¿å…æ­»é”æƒ…å†µï¼š</p>
<p><img src="/2024/05/06/oslab6/oslab6/1716035988152.png" alt="1716035988152"></p>
<h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. <strong>æ€»ç»“</strong></h2><p>åœ¨è¿™æ¬¡å®éªŒä¸­é€šè¿‡æ”¹å˜å‡ ä¸ªç»å…¸åŒæ­¥é—®é¢˜ï¼Œæˆ‘å­¦ä¹ äº†è‡ªæ—‹é”çš„å®ç°ï¼Œä¿¡å·é‡çš„ä½¿ç”¨ç­‰åŸºæœ¬çŸ¥è¯†ï¼Œè¿›ä¸€æ­¥äº†è§£äº†äº’æ–¥è®¿é—®çš„é—®é¢˜ï¼Œä½¿ç”¨SpinLockå’Œä¿¡å·é‡æ¥ç»™å‡ºå®ç°çº¿ç¨‹äº’æ–¥çš„è§£å†³æ–¹æ¡ˆã€‚åŠ æ·±äº†å¯¹ç†è®ºè¯¾çŸ¥è¯†çš„ç†è§£ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/22/oslab5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/22/oslab5/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-04-22 11:06:50" itemprop="dateCreated datePublished" datetime="2024-04-22T11:06:50+08:00">2024-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-05-06 11:09:22" itemprop="dateModified" datetime="2024-05-06T11:09:22+08:00">2024-05-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>title:SYSU-2024æ“ä½œç³»ç»Ÿlab3å®éªŒæŠ¥å‘Š</p>
<p>date:2024-04-28 23:54:26</p>
<p>tags:os</p>
<p>comments:true</p>
<h2 id="author-zyh"><a href="#author-zyh" class="headerlink" title="author:zyh"></a>author:zyh</h2><h1 id="å®éªŒåç§°-Lab5-å†…æ ¸çº¿ç¨‹"><a href="#å®éªŒåç§°-Lab5-å†…æ ¸çº¿ç¨‹" class="headerlink" title="å®éªŒåç§°:          Lab5 å†…æ ¸çº¿ç¨‹"></a>å®éªŒåç§°:          Lab5 å†…æ ¸çº¿ç¨‹</h1><p>å­¦ç”Ÿå§“å:                    åº„äº‘çš“</p>
<p>å­¦ç”Ÿå­¦å·:                   22336327</p>
<p>å®éªŒæˆç»©:</p>
<p>æŠ¥å‘Šæ—¶é—´:                   2023-5-5</p>
<h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><h3 id="Assignment-1-printfçš„å®ç°"><a href="#Assignment-1-printfçš„å®ç°" class="headerlink" title="Assignment 1 printfçš„å®ç°"></a>Assignment 1 printfçš„å®ç°</h3><p>å­¦ä¹ å¯å˜å‚æ•°æœºåˆ¶ï¼Œç„¶åå®ç°printfï¼Œä½ å¯ä»¥åœ¨ææ–™ä¸­çš„printfä¸Šè¿›è¡Œæ”¹è¿›ï¼Œæˆ–è€…ä»å¤´å¼€å§‹å®ç°è‡ªå·±çš„printfå‡½æ•°ã€‚ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<h3 id="Assignment-2-çº¿ç¨‹çš„å®ç°"><a href="#Assignment-2-çº¿ç¨‹çš„å®ç°" class="headerlink" title="Assignment 2 çº¿ç¨‹çš„å®ç°"></a>Assignment 2 çº¿ç¨‹çš„å®ç°</h3><p>è‡ªè¡Œè®¾è®¡PCBï¼Œå¯ä»¥æ·»åŠ æ›´å¤šçš„å±æ€§ï¼Œå¦‚ä¼˜å…ˆçº§ç­‰ï¼Œç„¶åæ ¹æ®ä½ çš„PCBæ¥å®ç°çº¿ç¨‹ï¼Œæ¼”ç¤ºæ‰§è¡Œç»“æœã€‚</p>
<h3 id="Assignment-3-çº¿ç¨‹è°ƒåº¦åˆ‡æ¢çš„ç§˜å¯†"><a href="#Assignment-3-çº¿ç¨‹è°ƒåº¦åˆ‡æ¢çš„ç§˜å¯†" class="headerlink" title="Assignment 3 çº¿ç¨‹è°ƒåº¦åˆ‡æ¢çš„ç§˜å¯†"></a>Assignment 3 çº¿ç¨‹è°ƒåº¦åˆ‡æ¢çš„ç§˜å¯†</h3><p>æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œçš„ç§˜å¯†åœ¨äºæˆ‘ä»¬éœ€è¦ä¸­æ–­çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œç„¶åè°ƒåº¦ä¸‹ä¸€ä¸ªçº¿ç¨‹ä¸Šå¤„ç†æœºï¼Œæœ€åä½¿è¢«è°ƒåº¦ä¸Šå¤„ç†æœºçš„çº¿ç¨‹ä»ä¹‹å‰è¢«ä¸­æ–­ç‚¹å¤„æ¢å¤æ‰§è¡Œã€‚ç°åœ¨ï¼ŒåŒå­¦ä»¬å¯ä»¥äº²æ‰‹æ­å¼€è¿™ä¸ªç§˜å¯†ã€‚</p>
<p>ç¼–å†™è‹¥å¹²ä¸ªçº¿ç¨‹å‡½æ•°ï¼Œä½¿ç”¨gdbè·Ÿè¸ª <code>c_time_interrupt_handler</code>ã€<code>asm_switch_thread</code>ç­‰å‡½æ•°ï¼Œè§‚å¯Ÿçº¿ç¨‹åˆ‡æ¢å‰åæ ˆã€å¯„å­˜å™¨ã€PCç­‰å˜åŒ–ï¼Œç»“åˆgdbã€ææ–™ä¸­â€œçº¿ç¨‹çš„è°ƒåº¦â€çš„å†…å®¹æ¥è·Ÿè¸ªå¹¶è¯´æ˜ä¸‹é¢ä¸¤ä¸ªè¿‡ç¨‹ã€‚</p>
<ul>
<li>ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«è°ƒåº¦ç„¶åå¼€å§‹æ‰§è¡Œçš„ã€‚</li>
<li>ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«ä¸­æ–­ç„¶åè¢«æ¢ä¸‹å¤„ç†å™¨çš„ï¼Œä»¥åŠæ¢ä¸Šå¤„ç†æœºååˆæ˜¯å¦‚ä½•ä»è¢«ä¸­æ–­ç‚¹å¼€å§‹æ‰§è¡Œçš„ã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šé¢è¿™ä¸ªç»ƒä¹ ï¼ŒåŒå­¦ä»¬åº”è¯¥èƒ½å¤Ÿè¿›ä¸€æ­¥ç†è§£æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°çº¿ç¨‹çš„å¹¶å‘æ‰§è¡Œçš„ã€‚</p>
<h3 id="ï¼ˆå¿…åšä¸é€‰åšï¼‰Assignment-4-è°ƒåº¦ç®—æ³•çš„å®ç°"><a href="#ï¼ˆå¿…åšä¸é€‰åšï¼‰Assignment-4-è°ƒåº¦ç®—æ³•çš„å®ç°" class="headerlink" title="ï¼ˆå¿…åšä¸é€‰åšï¼‰Assignment 4 è°ƒåº¦ç®—æ³•çš„å®ç°"></a>ï¼ˆå¿…åšä¸é€‰åšï¼‰Assignment 4 è°ƒåº¦ç®—æ³•çš„å®ç°</h3><p>åœ¨ææ–™ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨æ—¶é—´ç‰‡è½®è½¬ç®—æ³•æ¥å®ç°çº¿ç¨‹è°ƒåº¦ã€‚ä½†çº¿ç¨‹è°ƒåº¦ç®—æ³•ä¸æ­¢ä¸€ç§ï¼Œä¾‹å¦‚</p>
<ul>
<li>å…ˆæ¥å…ˆæœåŠ¡ã€‚</li>
<li>æœ€çŸ­ä½œä¸šï¼ˆè¿›ç¨‹ï¼‰ä¼˜å…ˆã€‚</li>
<li>å“åº”æ¯”æœ€é«˜è€…ä¼˜å…ˆç®—æ³•ã€‚</li>
<li>ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ã€‚</li>
<li>å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬çš„è°ƒåº¦ç®—æ³•è¿˜å¯ä»¥æ˜¯æŠ¢å å¼çš„ã€‚</p>
<p>ç°åœ¨ï¼ŒåŒå­¦ä»¬éœ€è¦å°†çº¿ç¨‹è°ƒåº¦ç®—æ³•ä¿®æ”¹ä¸ºä¸Šé¢æåˆ°çš„ç®—æ³•æˆ–è€…æ˜¯åŒå­¦ä»¬è‡ªå·±è®¾è®¡çš„ç®—æ³•ã€‚ç„¶åï¼ŒåŒå­¦ä»¬éœ€è¦è‡ªè¡Œç¼–å†™æµ‹è¯•æ ·ä¾‹æ¥å‘ˆç°ä½ çš„ç®—æ³•å®ç°çš„æ­£ç¡®æ€§å’ŒåŸºæœ¬é€»è¾‘ã€‚æœ€åï¼Œå°†ç»“æœæˆªå›¾å¹¶è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ã€‚<strong>ï¼ˆå…ˆæ¥å…ˆæœåŠ¡ä¸ºå¿…åšï¼Œå…¶ä»–ä¸ºé€‰åšï¼‰</strong></p>
<p>å‚è€ƒèµ„æ–™ï¼š<a href="https://gitee.com/link?target=https://zhuanlan.zhihu.com/p/97071815">https://zhuanlan.zhihu.com/p/97071815</a></p>
<p>Tipsï¼š</p>
<ul>
<li>å…ˆæ¥å…ˆæœåŠ¡æœ€ç®€å•ã€‚</li>
<li>æœ‰äº›è°ƒåº¦ç®—æ³•çš„å®ç°<strong>å¯èƒ½éœ€è¦</strong>ç”¨åˆ°ä¸­æ–­ã€‚</li>
</ul>
<h2 id="2-å®éªŒè¿‡ç¨‹"><a href="#2-å®éªŒè¿‡ç¨‹" class="headerlink" title="2. å®éªŒè¿‡ç¨‹"></a>2. <strong>å®éªŒè¿‡ç¨‹</strong></h2><h3 id="Assignment-1"><a href="#Assignment-1" class="headerlink" title="Assignment 1"></a>Assignment 1</h3><h4 id="1-1å¯å˜å‚æ•°æœºåˆ¶"><a href="#1-1å¯å˜å‚æ•°æœºåˆ¶" class="headerlink" title="1.1å¯å˜å‚æ•°æœºåˆ¶"></a>1.1å¯å˜å‚æ•°æœºåˆ¶</h4><p>å®ç°è¿™äº›å®</p>
<table>
<thead>
<tr>
<th>å®</th>
<th>ç”¨æ³•è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>va_list</code></td>
<td>å®šä¹‰ä¸€ä¸ªæŒ‡å‘å¯å˜å‚æ•°åˆ—è¡¨çš„æŒ‡é’ˆã€‚</td>
</tr>
<tr>
<td><code>void va_start(va_list ap, last_arg)</code></td>
<td>åˆå§‹åŒ–å¯å˜å‚æ•°åˆ—è¡¨æŒ‡é’ˆ <code>ap</code>ï¼Œä½¿å…¶æŒ‡å‘å¯å˜å‚æ•°åˆ—è¡¨çš„èµ·å§‹ä½ç½®ï¼Œå³å‡½æ•°çš„å›ºå®šå‚æ•°åˆ—è¡¨çš„æœ€åä¸€ä¸ªå‚æ•° <code>last_arg</code>çš„åé¢ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</td>
</tr>
<tr>
<td><code>type va_arg(va_list ap, type)</code></td>
<td>ä»¥ç±»å‹ <code>type</code>è¿”å›å¯å˜å‚æ•°ï¼Œå¹¶ä½¿ <code>ap</code>æŒ‡å‘ä¸‹ä¸€ä¸ªå‚æ•°ã€‚</td>
</tr>
<tr>
<td><code>void va_end(va_list ap)</code></td>
<td>æ¸…é›¶ <code>ap</code>ã€‚</td>
</tr>
</tbody></table>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> *va_list;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _INTSIZEOF(n) ((sizeof(n) + sizeof(int) - 1) &amp; ~(sizeof(int) - 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> va_start(ap, v) (ap = (va_list)&amp;v + _INTSIZEOF(v))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> va_arg(ap, type) (*(type *)((ap += _INTSIZEOF(type)) - _INTSIZEOF(type)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> va_end(ap) (ap = (va_list)0)</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œçš„ _INTSIZIOF: ~(sizeof(int) - 1)ä¸º0xfffffffc ,ä»»ä½•åœ°å€ä¸å®ƒ&amp;åå°†ä½ä¸¤ä½æ¸…é›¶ï¼Œä¸ºäº†å®ç°å‘ä¸Šå¯¹é½ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŠ ä¸Š(sizeof(int)-1)åå†å’Œ0xfffffffcç›¸ä¸ï¼Œæ­¤æ—¶å¾—åˆ°çš„ç»“æœå°±æ˜¯å‘ä¸Š4å­—èŠ‚å¯¹é½çš„ã€‚</p>
<h4 id="1-2-å®ç°printfå¢åŠ -bå’Œ-fåŠŸèƒ½"><a href="#1-2-å®ç°printfå¢åŠ -bå’Œ-fåŠŸèƒ½" class="headerlink" title="1.2 å®ç°printfå¢åŠ %bå’Œ%fåŠŸèƒ½"></a>1.2 å®ç°printfå¢åŠ %bå’Œ%fåŠŸèƒ½</h4><p>å®ç°äº†print(â€œ%b,n),jå’Œprint(â€œ%fâ€,n),åˆ†åˆ«å°†iä»¥2è¿›åˆ¶å’Œfloatæµ®ç‚¹æ•°ï¼Œä¿ç•™å…­ä½å°æ•°è¾“å‡º</p>
<p>è®©æˆ‘ä»¬å…ˆè§£é‡Šä¸€ä¸‹printfå®ç°çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å¯å˜å‚æ•°æœºåˆ¶ï¼Œ</p>
<p>è§£é‡Šä¸€ä¸‹printfä¸­çš„ä»£ç ï¼š</p>
<p>å¦‚æœ % çš„ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯â€™\0â€™ï¼Œåˆ™é€€å‡ºï¼›å¦‚æœæ˜¯â€™câ€™ï¼Œåˆ™ä»¥å­—ç¬¦çš„æ ¼å¼è¿”å›ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°ï¼Œå¹¶å°†å…¶åŠ å…¥ç¼“å†²åŒºï¼›å¦‚æœæ˜¯â€™sâ€™ï¼Œåˆ™è¾“å‡ºå¹¶æ¸…ç©ºç¼“å†²åŒºï¼Œå¹¶ä»¥char*çš„æ ¼å¼è¿”å›ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°ï¼Œå¹¶ç›´æ¥æ‰“å°ï¼›å¦‚æœæ˜¯â€™dâ€™ï¼Œåˆ™ä»¥intçš„æ ¼å¼è¿”å›ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ååŠ å…¥ç¼“å†²åŒºï¼›å¦‚æœæ˜¯â€™xâ€™ï¼Œåˆ™ä»¥intçš„æ ¼å¼è¿”å›ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°ï¼Œè¿›è¡Œè¿›åˆ¶è½¬æ¢ï¼Œç„¶åè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ŒåŠ å…¥ç¼“å†²åŒºï¼›</p>
<p>%bçš„å®ç°åªéœ€æŠŠ%xä¸­çš„itos(number, temp, (fmt[i] &#x3D;&#x3D; â€˜dâ€™ ? 10 : 16));æ”¹æˆitos(number, temp, (fmt[i] &#x3D;&#x3D; â€˜dâ€™ ? 10 : 2));</p>
<p>%fçš„å®ç°å‚è€ƒäº†<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44078824/article/details/118440458">printfçš„å®ç°</a></p>
<p>ç®€å•åœ°è¯´ï¼Œå…ˆæŠŠæµ®ç‚¹æ•°åˆ†æˆæ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†ï¼Œç„¶åå°†æ•´æ•°å’Œå°æ•°åˆ†åˆ«è½¬æ¢ä¸ºå•ä¸ªå­—ç¬¦æ‰“å°ã€‚å› ä¸ºæ˜¯ä¿ç•™å…­ä½å°æ•°ï¼Œå°æ•°å…ˆ*1000000å†æŒ‰æ•´æ•°æ–¹å¼æ¥æ‰“å°ï¼Œå…·ä½“ä»£ç è§å…³é”®ä»£ç éƒ¨åˆ†</p>
<p>æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;print percentage: %%\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print char \&quot;N\&quot;: %c\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print string \&quot;Hello World!\&quot;: %s\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print decimal: \&quot;-1234\&quot;: %d\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print hexadecimal \&quot;0x7abcdef0\&quot;: %x\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print binary \&quot;0b10\&quot;: %b\n&quot;</span></span><br><span class="line">           <span class="string">&quot;print float \&quot;3.1415\&quot;: %f\n&quot;</span>,</span><br><span class="line">           <span class="string">&#x27;N&#x27;</span>, <span class="string">&quot;Hello World!&quot;</span>, <span class="number">-1234</span>, <span class="number">0x7abcdef0</span>, <span class="number">0b10</span>,<span class="number">3.1415</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Assignment-2"><a href="#Assignment-2" class="headerlink" title="Assignment 2"></a>Assignment 2</h3><h4 id="çº¿ç¨‹çš„æè¿°"><a href="#çº¿ç¨‹çš„æè¿°" class="headerlink" title="çº¿ç¨‹çš„æè¿°"></a>çº¿ç¨‹çš„æè¿°</h4><p>å…ˆä»‹ç»ä¸€ä¸‹è¿›ç¨‹æ§åˆ¶å—PCB:</p>
<p>åœ¨å®éªŒä¸­ç”¨ä¸€ä¸ªç»“æ„ä½“è¡¨ç¤ºï¼ŒåŒ…æ‹¬æ ˆæŒ‡é’ˆï¼Œçº¿ç¨‹åï¼ŒçŠ¶æ€ï¼Œä¼˜å…ˆçº§ï¼Œçº¿ç¨‹idç­‰å†…å®¹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PCB</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> *stack;                      <span class="comment">// æ ˆæŒ‡é’ˆï¼Œç”¨äºè°ƒåº¦æ—¶ä¿å­˜esp</span></span><br><span class="line">    <span class="type">char</span> name[MAX_PROGRAM_NAME + <span class="number">1</span>]; <span class="comment">// çº¿ç¨‹å</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">ProgramStatus</span> status;       <span class="comment">// çº¿ç¨‹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> priority;                    <span class="comment">// çº¿ç¨‹ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="type">int</span> pid;                         <span class="comment">// çº¿ç¨‹pid</span></span><br><span class="line">    <span class="type">int</span> ticks;                       <span class="comment">// çº¿ç¨‹æ—¶é—´ç‰‡æ€»æ—¶é—´</span></span><br><span class="line">    <span class="type">int</span> ticksPassedBy;               <span class="comment">// çº¿ç¨‹å·²æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    ListItem tagInGeneralList;       <span class="comment">// çº¿ç¨‹é˜Ÿåˆ—æ ‡è¯†</span></span><br><span class="line">    ListItem tagInAllList;           <span class="comment">// çº¿ç¨‹é˜Ÿåˆ—æ ‡è¯†</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šå‡ ä¸ªå˜é‡çš„å«ä¹‰ï¼š<br>ticksæ˜¯çº¿ç¨‹å‰©ä½™çš„æ‰§è¡Œæ¬¡æ•°ã€‚åœ¨æ—¶é—´ç‰‡è°ƒåº¦ç®—æ³•ä¸­ï¼Œæ¯å‘ç”Ÿä¸­æ–­ä¸€æ¬¡è®°ä¸ºä¸€ä¸ªtickï¼Œå½“ticks&#x3D;0æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«æ¢ä¸‹å¤„ç†å™¨ï¼Œç„¶åå°†å…¶ä»–çº¿ç¨‹æ¢ä¸Šå¤„ç†å™¨æ‰§è¡Œã€‚</p>
<p>ticksPassedByæ˜¯çº¿ç¨‹æ€»å…±æ‰§è¡Œçš„tickçš„æ¬¡æ•°ã€‚</p>
<p>tagInGeneralListå’ŒtagInAllListæ˜¯çº¿ç¨‹åœ¨çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„æ ‡è¯†ï¼Œç”¨äºåœ¨çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‰¾åˆ°çº¿ç¨‹çš„PCBã€‚è¿™ä¸¤ä¸ªå˜é‡çš„lListItemç±»å‹è¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­ä¸¤ä¸ªæŒ‡é’ˆå˜é‡åˆ†åˆ«æŒ‡å‘å‰é¢å’Œåé¢çš„å…ƒç´ ã€‚ç”¨é“¾è¡¨æ¥å®ç°è¿›ç¨‹é˜Ÿåˆ—ï¼Œé“¾è¡¨ç»“æ„è¯¦è§ â€˜include&#x2F;list.hâ€™</p>
<p>stackçº¿ç¨‹æ ˆè¡¨ç¤ºå¦‚ä¸‹</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714812925884.png" alt="1714812925884"></p>
<p>å¯¹è®¸å¤šçº¿ç¨‹ç®¡ç†æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ªå£°æ˜ä¸€ä¸ªç¨‹åºç®¡ç†ç±» <code>ProgramManager.</code></p>
<p>ç”¨äºçº¿ç¨‹å’Œè¿›ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ï¼Œä»£ç è§ <code>include/program.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PROGRAM_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROGRAM_H</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProgramManager</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="çº¿ç¨‹çš„åˆ›å»ºï¼š"><a href="#çº¿ç¨‹çš„åˆ›å»ºï¼š" class="headerlink" title="çº¿ç¨‹çš„åˆ›å»ºï¼š"></a>çº¿ç¨‹çš„åˆ›å»ºï¼š</h4><p>1.æˆ‘ä»¬åœ¨ <code>include/program.h</code>ä¸­å¯¹ç¨‹åºç®¡ç†ç±» <code>ProgramManager</code>ä¸­çš„å˜é‡å’Œå‡½æ•°è¿›è¡Œå£°æ˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProgramManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    List allPrograms;   <span class="comment">// æ‰€æœ‰çŠ¶æ€çš„çº¿ç¨‹/è¿›ç¨‹çš„é˜Ÿåˆ—</span></span><br><span class="line">    List readyPrograms; <span class="comment">// å¤„äºready(å°±ç»ªæ€)çš„çº¿ç¨‹/è¿›ç¨‹çš„é˜Ÿåˆ—</span></span><br><span class="line">    PCB *running;       <span class="comment">// å½“å‰æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ProgramManager</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ”¾å…¥å°±ç»ªé˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// functionï¼šçº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">    <span class="comment">// parameterï¼šæŒ‡å‘å‡½æ•°çš„å‚æ•°çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// nameï¼šçº¿ç¨‹çš„åç§°</span></span><br><span class="line">    <span class="comment">// priorityï¼šçº¿ç¨‹çš„ä¼˜å…ˆçº§</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆåŠŸï¼Œè¿”å›pidï¼›å¤±è´¥ï¼Œè¿”å›-1</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">executeThread</span><span class="params">(ThreadFunction function, <span class="type">void</span> *parameter, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> priority)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªPCB</span></span><br><span class="line">    <span class="function">PCB *<span class="title">allocatePCB</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// å½’è¿˜ä¸€ä¸ªPCB</span></span><br><span class="line">    <span class="comment">// programï¼šå¾…é‡Šæ”¾çš„PCB</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">releasePCB</span><span class="params">(PCB *program)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œçº¿ç¨‹è°ƒåº¦</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">schedule</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// zu se huan xing</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">MESA_WakeUp</span><span class="params">(PCB *program)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">program_exit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.å‘å†…å­˜ç”³è¯·PCBç©ºé—´ï¼ˆä»¥ä¸‹å†…å®¹è§src&#x2F;kernel&#x2F;program.cpp)</p>
<p>ï¼ˆ1ï¼‰å£°æ˜PCBçš„ç©ºé—´å’ŒPCBåˆ†é…çŠ¶æ€æ•°ç»„</p>
<p>åœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€ä¸ªPCB_SIZE * MAX_PROGRAM_AMOUNTä¸ªå­—èŠ‚çš„ç©ºé—´ç”¨äºåˆ†é…ç»™æ‰€æœ‰çº¿ç¨‹çš„thread-&gt;stackã€‚è¿™é‡Œæˆ‘ä»¬æŠŠPCBå¤§å°è®¾ç½®ä¸º4096ï¼ˆ4kb)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> PCB_SET[PCB_SIZE * MAX_PROGRAM_AMOUNT];<span class="comment">//MAX_PROGRAM_AMOUNTä¸ªPCBçš„å¤§å°ç©ºé—´</span></span><br></pre></td></tr></table></figure>

<p>å†ç”¨ä¸€ä¸ªboolç±»å‹æ•°ç»„è¡¨ç¤ºPCBåˆ†é…çŠ¶æ€</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PCBçš„åˆ†é…çŠ¶æ€ï¼Œtrueè¡¨ç¤ºå·²ç»åˆ†é…ï¼Œfalseè¡¨ç¤ºæœªåˆ†é…ã€‚</span></span><br><span class="line"><span class="type">bool</span> PCB_SET_STATUS[MAX_PROGRAM_AMOUNT];   </span><br></pre></td></tr></table></figure>

<p>å¦‚æœå·²ç»ç»™ä¸€ä¸ªçº¿ç¨‹åˆ†é…äº†PCBåˆ™å°†è¯¥çº¿ç¨‹å¯¹åº”çš„PCB_SET_STATUSä¸­çš„æ•°ç½®1</p>
<p>ï¼ˆ2ï¼‰allocatePCBå’ŒreleasePCB</p>
<p>å…·ä½“è¿›è¡Œåˆ†é…çš„è¿‡ç¨‹æˆ‘ä»¬é€šè¿‡program_managerä¸­çš„å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªPCB</span></span><br><span class="line"><span class="function">PCB *<span class="title">allocatePCB</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// å½’è¿˜ä¸€ä¸ªPCB</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">releasePCB</span><span class="params">(PCB *program)</span></span>;</span><br></pre></td></tr></table></figure>

<p>æ¥å®ç°ã€‚ä¸¤ä¸ªå‡½æ•°å®ç°çš„ä»£ç æ”¾ç½®åœ¨ <code>src/kernel/program.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PCB *<span class="title">ProgramManager::allocatePCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PROGRAM_AMOUNT; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!PCB_SET_STATUS[i])</span><br><span class="line">        &#123;</span><br><span class="line">            PCB_SET_STATUS[i] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> (PCB *)((<span class="type">int</span>)PCB_SET + PCB_SIZE * i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å¯¹PCB_SET_STATUSä¸­çš„å…ƒç´ ä¾æ¬¡åˆ¤æ–­çœ‹è¯¥ä½ç½®å¯¹åº”çš„PCB_SETç©ºé—´æ˜¯å¦å·²ç»è¢«ç±»é…äº†ï¼Œå¦‚æœæ²¡æœ‰æ²¡æœ‰åˆ™è¿”å›ç¬¬iä¸ªPCBçš„èµ·å§‹åœ°å€ï¼ˆå¯¹äºç¬¬ğ‘–ä¸ªPCBï¼Œ<code>PCB_SET</code>çš„é¦–åœ°å€åŠ ä¸Š<strong>i</strong>Ã—<strong>P</strong>C<strong>B</strong>S<strong>I</strong>Z<strong>E</strong>ğ‘–Ã—ğ‘ƒğ¶ğµğ‘†ğ¼ğ‘ğ¸å°±æ˜¯ç¬¬<strong>i</strong>ğ‘–ä¸ªPCBçš„èµ·å§‹åœ°å€ï¼‰</p>
<p>æœ‰PCBçš„åˆ†é…å°±æœ‰PCBçš„é‡Šæ”¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProgramManager::releasePCB</span><span class="params">(PCB *program)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> index = ((<span class="type">int</span>)program - (<span class="type">int</span>)PCB_SET) / PCB_SIZE;</span><br><span class="line">    PCB_SET_STATUS[index] = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>releasePCB</code>æ¥å—ä¸€ä¸ªPCBæŒ‡é’ˆ <code>program</code>ï¼Œç„¶åè®¡ç®—å‡º <code>program</code>æŒ‡å‘çš„PCBåœ¨ <code>PCB_SET</code>ä¸­çš„ä½ç½®ï¼Œç„¶åå°† <code>PCB_SET_STATUS</code>ä¸­çš„å¯¹åº”ä½ç½®è®¾ç½® <code>false</code>å³å¯ã€‚</p>
<p>ï¼ˆ3ï¼‰excuteThreadçš„å®ç°</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬è§„å®šçº¿ç¨‹åªèƒ½æ‰§è¡Œè¿”å›å€¼ä¸ºvoidï¼Œå‚æ•°ä¸ºvoid *çš„å‡½æ•°<br>æˆ‘ä»¬åœ¨include&#x2F;Program.hä¸­å°†ä¸Šé¢æåˆ°çš„è¿™ä¸ªå‡½æ•°å®šä¹‰ä¸ºThreadFunctionã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*ThreadFunction)</span><span class="params">(<span class="type">void</span> *)</span></span>;</span><br></pre></td></tr></table></figure>

<p>åœ¨ProgramManagerç±»ä¸­å£°æ˜ä¸€ä¸ªç”¨äºåˆ›å»ºçº¿ç¨‹çš„å‡½æ•°executeThreadï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ”¾å…¥å°±ç»ªé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// functionï¼šçº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">    <span class="comment">// parameterï¼šæŒ‡å‘å‡½æ•°çš„å‚æ•°çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// nameï¼šçº¿ç¨‹çš„åç§°</span></span><br><span class="line">    <span class="comment">// priorityï¼šçº¿ç¨‹çš„ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="comment">// æˆåŠŸï¼Œè¿”å›pidï¼›å¤±è´¥ï¼Œè¿”å›-1</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">executeThread</span><span class="params">(ThreadFunction function, <span class="type">void</span> *parameter, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> priority)</span></span>;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨src&#x2F;kernel&#x2F;program.cppä¸­å®ç°executeThreadï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">ProgramManager::executeThread</span><span class="params">(ThreadFunction function, <span class="type">void</span> *parameter, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> priority)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å…³ä¸­æ–­ï¼Œé˜²æ­¢åˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹è¢«æ‰“æ–­</span></span><br><span class="line">    <span class="type">bool</span> status = interruptManager.<span class="built_in">getInterruptStatus</span>();</span><br><span class="line">    interruptManager.<span class="built_in">disableInterrupt</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€é¡µä½œä¸ºPCB</span></span><br><span class="line">    PCB *thread = <span class="built_in">allocatePCB</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!thread)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–åˆ†é…çš„é¡µ</span></span><br><span class="line">    <span class="built_in">memset</span>(thread, <span class="number">0</span>, PCB_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_PROGRAM_NAME &amp;&amp; name[i]; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        thread-&gt;name[i] = name[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    thread-&gt;status = ProgramStatus::READY;</span><br><span class="line">    thread-&gt;priority = priority;</span><br><span class="line">    thread-&gt;ticks = priority * <span class="number">10</span>;</span><br><span class="line">    thread-&gt;ticksPassedBy = <span class="number">0</span>;</span><br><span class="line">    thread-&gt;pid = ((<span class="type">int</span>)thread - (<span class="type">int</span>)PCB_SET) / PCB_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ ˆ</span></span><br><span class="line">    thread-&gt;stack = (<span class="type">int</span> *)((<span class="type">int</span>)thread + PCB_SIZE);</span><br><span class="line">    thread-&gt;stack -= <span class="number">7</span>;</span><br><span class="line">    thread-&gt;stack[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    thread-&gt;stack[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    thread-&gt;stack[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    thread-&gt;stack[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    thread-&gt;stack[<span class="number">4</span>] = (<span class="type">int</span>)function;</span><br><span class="line">    thread-&gt;stack[<span class="number">5</span>] = (<span class="type">int</span>)program_exit;</span><br><span class="line">    thread-&gt;stack[<span class="number">6</span>] = (<span class="type">int</span>)parameter;</span><br><span class="line"></span><br><span class="line">    allPrograms.<span class="built_in">push_back</span>(&amp;(thread-&gt;tagInAllList));</span><br><span class="line">    readyPrograms.<span class="built_in">push_back</span>(&amp;(thread-&gt;tagInGeneralList));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤ä¸­æ–­</span></span><br><span class="line">    interruptManager.<span class="built_in">setInterruptStatus</span>(status);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> thread-&gt;pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç°åœ¨é€æ­¥åœ°åˆ†æçº¿ç¨‹åˆ›å»ºçš„é€»è¾‘ã€‚</p>
<p>ï¼ˆ1ï¼‰å…³ä¸­æ–­</p>
<p>3-5è¡Œä¿å­˜ä¸­æ–­çŠ¶æ€ç„¶åå…³ä¸­æ–­ï¼Œè¯¸å¦‚PCBåˆ†é…çš„å·¥ä½œå®é™…ä¸Šéƒ½éœ€è¦è¿›è¡Œçº¿ç¨‹äº’æ–¥å¤„ç†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨å¼€å…³ä¸­æ–­å®ç°çº¿ç¨‹äº’æ–¥ä¸ºä»€ä¹ˆå¼€&#x2F;å…³ä¸­æ–­æœ‰æ•ˆå‘¢ï¼Ÿåœ¨åé¢å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ˜¯åœ¨æ—¶é’Ÿä¸­æ–­å‘ç”Ÿæ—¶æ¥è¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„ï¼Œå› æ­¤å…³ä¸­æ–­åï¼Œæ—¶é’Ÿä¸­æ–­æ— æ³•è¢«å“åº”ï¼Œçº¿ç¨‹å°±æ— æ³•è¢«è°ƒåº¦ï¼Œç›´åˆ°å†æ¬¡å¼€ä¸­æ–­ã€‚åªè¦çº¿ç¨‹æ— æ³•è¢«è°ƒåº¦ï¼Œé‚£ä¹ˆçº¿ç¨‹çš„å·¥ä½œä¹Ÿå°±æ— æ³•è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œå› æ­¤å°±å®ç°äº†çº¿ç¨‹äº’æ–¥ã€‚</p>
<p>å…³ä¸­æ–­åï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‡½æ•°è¿”å›å‰ï¼Œä¹Ÿå°±æ˜¯ç¬¬44è¡Œæ¢å¤ä¸­æ–­ã€‚</p>
<p>å¼€&#x2F;å…³ä¸­æ–­ç­‰ç›¸å…³çš„çš„å‡½æ•°å®šä¹‰åœ¨ <code>include/interrupt.h</code>ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InterruptManager</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enableInterrupt</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// å…³ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">disableInterrupt</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è·å–ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// è¿”å›trueï¼Œä¸­æ–­å¼€å¯ï¼›è¿”å›falseï¼Œä¸­æ–­å…³é—­</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getInterruptStatus</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸­æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// status=trueï¼Œå¼€ä¸­æ–­ï¼›status=falseï¼Œå…³ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setInterruptStatus</span><span class="params">(<span class="type">bool</span> status)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œæ”¾ç½®åœ¨ <code>src/interrupt/interrupt.cpp</code>ä¸­ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜è¿°ï¼Œç°åœ¨æˆ‘ä»¬å›åˆ° <code>executeThread</code>ã€‚</p>
<p>ï¼ˆ2ï¼‰ç”³è¯·PCBç©ºé—´ï¼Œå¯¹PCBä¸­çš„å†…å®¹è¿›è¡Œåˆå§‹åŒ–</p>
<p>ç¬¬8è¡Œï¼Œå…³ä¸­æ–­åï¼Œæˆ‘ä»¬å‘ <code>PCB_SET</code>ç”³è¯·ä¸€ä¸ªçº¿ç¨‹çš„PCBï¼Œç„¶åæˆ‘ä»¬åœ¨ç¬¬14è¡Œä½¿ç”¨ <code>memeset</code>å°†PCBæ¸…0ã€‚<code>memeset</code>çš„å£°æ˜å’Œå®šä¹‰åˆ†åˆ«åœ¨ <code>include/stdlib.h</code>å’Œ <code>src/utils/stdlib.cpp</code>ã€‚</p>
<p>ç¬¬16-25è¡Œï¼Œæˆ‘ä»¬è®¾ç½®PCBçš„æˆå‘˜ <code>name</code>ã€<code>status</code>ã€<code>priority</code>ã€<code>ticks</code>ã€<code>ticksPassedBy</code>å’Œ <code>pid</code>ã€‚è¿™é‡Œï¼Œçº¿ç¨‹åˆå§‹çš„ <code>ticks</code>æˆ‘ä»¬ç®€å•åœ°è®¾ç½®ä¸º <code>10</code>å€çš„ <code>priority</code>ã€‚<code>pid</code>åˆ™ç®€å•åœ°ä½¿ç”¨PCBåœ¨ <code>PCB_SET</code>çš„ä½ç½®æ¥ä»£æ›¿ã€‚</p>
<p>ç¬¬28è¡Œï¼Œæˆ‘ä»¬åˆå§‹åŒ–çº¿ç¨‹çš„æ ˆã€‚æˆ‘ä»¬å°†æ ˆæ”¾ç½®åœ¨PCBä¸­ï¼Œè€Œçº¿ç¨‹çš„æ ˆæ˜¯ä»PCBçš„é¡¶éƒ¨å¼€å§‹å‘ä¸‹å¢é•¿çš„ï¼Œæ‰€ä»¥ä¸ä¼šä¸ä½äºPCBä½åœ°å€çš„ <code>name</code>å’Œ <code>pid</code>ç­‰å˜é‡å†²çªã€‚çº¿ç¨‹æ ˆçš„åˆå§‹åœ°å€æ˜¯PCBçš„èµ·å§‹åœ°å€åŠ ä¸Š <code>PCB_SIZE</code>ã€‚</p>
<p>ç¬¬29-36è¡Œï¼Œæˆ‘ä»¬åœ¨æ ˆä¸­æ”¾å…¥7ä¸ªæ•´æ•°å€¼ã€‚</p>
<ul>
<li>4ä¸ªä¸º0çš„å€¼æ˜¯è¦æ”¾åˆ°ebpï¼Œebxï¼Œediï¼Œesiä¸­çš„ã€‚</li>
<li><code>thread-&gt;stack[4]</code>æ˜¯çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚</li>
<li><code>thread-&gt;stack[5]</code>æ˜¯çº¿ç¨‹çš„è¿”å›åœ°å€ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åéƒ½ä¼šè¿”å›åˆ°è¿™ä¸ªåœ°å€ã€‚</li>
<li><code>thread-&gt;stack[6]</code>æ˜¯çº¿ç¨‹çš„å‚æ•°çš„åœ°å€ã€‚</li>
</ul>
<p>è‡³äºè¿™4éƒ¨ä»½çš„ä½œç”¨æˆ‘ä»¬åœ¨çº¿ç¨‹çš„è°ƒåº¦ä¸­ç»Ÿä¸€è®²è§£ã€‚</p>
<p>ï¼ˆ3ï¼‰å°†çº¿ç¨‹æ”¾è¿› <code>allPrograms</code>å’Œ <code>readyPrograms</code></p>
<p>åˆ›å»ºå®Œçº¿ç¨‹çš„PCBåï¼Œæˆ‘ä»¬å°†å…¶æ”¾å…¥åˆ° <code>allPrograms</code>å’Œ <code>readyPrograms</code>ä¸­ï¼Œç­‰å¾…æ—¶é’Ÿä¸­æ–­æ¥çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹å°±å¯ä»¥è¢«è°ƒåº¦ä¸Šå¤„ç†å™¨ã€‚</p>
<p>ï¼ˆ4)å¼€ä¸­æ–­</p>
<p>æœ€åæˆ‘ä»¬å°†ä¸­æ–­çš„çŠ¶æ€æ¢å¤ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<h3 id="Assignment-3"><a href="#Assignment-3" class="headerlink" title="Assignment 3"></a>Assignment 3</h3><h4 id="3-1ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«è°ƒåº¦ç„¶åå¼€å§‹æ‰§è¡Œ"><a href="#3-1ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«è°ƒåº¦ç„¶åå¼€å§‹æ‰§è¡Œ" class="headerlink" title="3.1ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«è°ƒåº¦ç„¶åå¼€å§‹æ‰§è¡Œ?"></a>3.1ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«è°ƒåº¦ç„¶åå¼€å§‹æ‰§è¡Œ?</h4><p>æˆ‘ä»¬æ¥çœ‹setup.cppä¸­è°ƒç”¨çš„æ±‡ç¼–å‡½æ•°asm_switch_thread(0, firstThread);<br>å°†å‚æ•°å’Œè¿”å›åœ°å€å‹æ ˆåï¼Œæˆ‘ä»¬å°† <code>ebp</code>ï¼Œ<code>ebx</code>ï¼Œ<code>edi</code>ï¼Œ<code>esi</code> ä¾æ¬¡å‹æ ˆï¼ˆå› ä¸ºè¿™å‡ ä¸ªå­˜å™¨çš„å€¼å¯èƒ½ä¼šåœ¨è¢«è°ƒå‡½æ•°ä¸­è¢«ä¿®æ”¹ï¼Œè¦å…ˆä¿æŠ¤èµ·æ¥ï¼‰ã€‚ç°åœ¨çš„æ ˆçŠ¶æ€å¦‚ä¸‹ï¼š</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714905739957.png" alt="1714905739957"></p>
<p>29è¡Œ[esp+5 * 4]è¡¨ç¤ºPCB * curè¿™ä¸ªæŒ‡é’ˆå˜é‡çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯æŒ‡å‘ç©ºé—´çš„åœ°å€ï¼‰ï¼ŒæŠŠå®ƒèµ‹å€¼ç»™eaxã€‚32è¡Œ[esp+6 * 4]åˆ™æ˜¯PCB *next.</p>
<p>æ³¨æ„30è¡Œä¿å­˜å½“å‰æ ˆæŒ‡é’ˆespåˆ°PCB::stackä¸­.[eax]å°±æ˜¯PCB * curè¿™ä¸ªæŒ‡é’ˆå˜é‡çš„å€¼, å› ä¸ºPCBç¬¬ä¸€ä¸ªå˜é‡å°±æ˜¯int <em><em>stack,[eax]å…¶å®å°±æ˜¯</em>PCB::stackæ‰€åœ¨åœ°å€(int*)((int)thread+PCB_SIZE)-7</em></p>
<p><em>ä¸‹é¢32-33è¡Œæˆ‘ä»¬å°†PCB</em> nextå€¼å†™å…¥eax,å°†next-&gt;stackçš„å€¼å†™å…¥esp<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨espç”±åŸæ¥çº¿ç¨‹çš„stackåˆ‡æ¢ä¸ºäº†next-&gt;stack.</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714908742419.png" alt="1714908742419"></p>
<p>é€šè¿‡è°ƒè¯•è¿‡ç¨‹æ¥å…·ä½“è§‚å¯Ÿä¸€ä¸‹ï¼š<br>åˆå§‹æ—¶espä¸º0x7bc0,</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714840614902.png" alt="1714840614902"></p>
<p>33è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°espçš„å€¼å˜æˆäº†thread1çš„stackçš„åœ°å€,æ¥ç€36è¡Œåˆ°39è¡Œå¼¹å‡ºthread1çš„æ ˆä¸­å†…å®¹ï¼ˆå…¨éƒ½æ˜¯0ï¼‰åˆ°å››ä¸ªå¯„å­˜å™¨ä¸­ã€‚å› ä¸ºç°åœ¨çš„espå·²ç»å˜æˆäº†thread1çš„stack,è¿”å›åœ°å€ä¹Ÿæ˜¯å‡½æ•°first_threadçš„é¦–åœ°å€ã€‚retæ‰§è¡Œåå°±è·³è½¬åˆ°äº†first_threadå‡½æ•°ã€‚ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…ˆpop4ä¸ª0åˆ°å¯„å­˜å™¨ï¼Œç„¶åè¿”å›ï¼Œè¿”å›åœ°å€æ˜¯functionçš„åœ°å€ï¼‰</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714909688608.png" alt="1714909688608"><br><img src="/2024/04/22/oslab5/oslab5/1714909446513.png" alt="1714909446513"><br>ç„¶åæˆ‘ä»¬ä¾¿è¿›å…¥äº†first_thread<br><img src="/2024/04/22/oslab5/oslab5/1714909863122.png" alt="1714909863122"></p>
<h4 id="3-2ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«ä¸­æ–­ç„¶åè¢«æ¢ä¸‹å¤„ç†å™¨çš„ï¼Œä»¥åŠæ¢ä¸Šå¤„ç†å™¨ååˆæ˜¯å¦‚ä½•ä»è¢«ä¸­æ–­ç‚¹å¼€å§‹æ‰§è¡Œçš„"><a href="#3-2ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«ä¸­æ–­ç„¶åè¢«æ¢ä¸‹å¤„ç†å™¨çš„ï¼Œä»¥åŠæ¢ä¸Šå¤„ç†å™¨ååˆæ˜¯å¦‚ä½•ä»è¢«ä¸­æ–­ç‚¹å¼€å§‹æ‰§è¡Œçš„" class="headerlink" title="3.2ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«ä¸­æ–­ç„¶åè¢«æ¢ä¸‹å¤„ç†å™¨çš„ï¼Œä»¥åŠæ¢ä¸Šå¤„ç†å™¨ååˆæ˜¯å¦‚ä½•ä»è¢«ä¸­æ–­ç‚¹å¼€å§‹æ‰§è¡Œçš„?"></a>3.2ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦‚ä½•è¢«ä¸­æ–­ç„¶åè¢«æ¢ä¸‹å¤„ç†å™¨çš„ï¼Œä»¥åŠæ¢ä¸Šå¤„ç†å™¨ååˆæ˜¯å¦‚ä½•ä»è¢«ä¸­æ–­ç‚¹å¼€å§‹æ‰§è¡Œçš„?</h4><p>ç°åœ¨æˆ‘ä»¬ç€é‡å…³æ³¨RRæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦çš„è¿‡ç¨‹ï¼Œé¦–å…ˆåœ¨ä¸­æ–­å¤„ç†å‡½æ•°å¤„è®¾ç½®æ–­ç‚¹ï¼š</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714910381025.png" alt="1714910381025"></p>
<p>è§‚å¯Ÿcur-&gt;tickså’Œcur-&gt;ticksPassedByçš„å˜åŒ–<br><img src="/2024/04/22/oslab5/oslab5/1714910209537.png" alt="1714910209537"></p>
<p>æ¯ä¸€æ¬¡å‘ç”Ÿæ—¶é’Ÿä¸­æ–­æ—¶ï¼Œä¸­æ–­å¤„ç†å‡½æ•°éƒ½ä¼šå°†å½“å‰è¿›ç¨‹PCBçš„ticks-1,ticksPassedBy+1,å½“cur-&gt;ticksä¸º0æ—¶è¿›è¡Œè¿›ç¨‹åˆ‡æ¢ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªè¿›ç¨‹å¦‚ä½•è¢«æ¢ä¸‹å¤„ç†å™¨ã€‚æ—¶é—´ç‰‡ç”¨å®Œåè¿›è¡Œè°ƒåº¦ï¼Œè¿›å…¥scheduleå‡½æ•°å†…éƒ¨ï¼Œå› ä¸ºå½“å‰è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨readyé˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå¹¶å°†ticksé‡ç½®ã€‚</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714911275547.png" alt="1714911275547"></p>
<p>æ¥ç€è·å–readyé˜Ÿåˆ—çš„å¤´ä¸€ä¸ªå…ƒç´ ï¼Œç®€å•åšä¸€äº›å˜é‡çš„ä¿®æ”¹åï¼ŒæŠŠreadyé˜Ÿåˆ—å¤´popå‡ºæ¥ï¼Œæ¥ç€æˆ‘ä»¬åˆè¿›å…¥äº†asm_swith_thread(cur,next)</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714911725209.png" alt="1714911725209"></p>
<p>è¿›è¡Œçº¿ç¨‹æ ˆçš„åˆ‡æ¢ï¼Œretåè¿”å›second_thread.</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714912484030.png" alt="1714912484030"></p>
<p>thread1å·²ç»è¢«æ¢ä¸‹å¤„ç†å™¨äº†ï¼Œthread1ä¸‹ä¸€æ¬¡è¢«æ¢ä¸Šå¤„ç†å™¨æ˜¯å…·ä½“å¦‚ä½•æ‰§è¡Œçš„å‘¢?</p>
<p>thread3çš„æ—¶é—´ç‰‡ç”¨å®Œä»¥åï¼Œè¿›å…¥sceduleå‡½æ•°ï¼Œè°ƒç”¨asm_swith_thread(cur,next),æ­¤æ—¶çš„nextæŒ‡å‘çš„æ˜¯thread1,å› ä¸ºthread1å·²ç»ä¸æ˜¯æ–°çš„è¿›ç¨‹äº†ï¼Œæ­¤æ—¶å®ƒçš„ebpä¸ä¸º0.</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714913439195.png" alt="1714913439195"></p>
<p>æ³¨æ„åˆ°ï¼Œè¿™é‡Œå‡½æ•°è¿”å›åœ°å€132695æ˜¯scheduleå‡½æ•°ä¸­è°ƒç”¨asm_swith_thread(cur,next)è¯­å¥çš„åœ°å€ï¼Œè°ƒç”¨å®Œè¯¥å‡½æ•°åè¿”å›åŸæ¥ä½ç½®ã€‚ç„¶åscheduleå‡½æ•°æ‰§è¡Œå®Œï¼Œç»§ç»­æ‰§è¡Œå®Œä»–æ‰€åœ¨çš„c_time_interrupt_handleåè¿”å›asm_time_interrupt_handleï¼Œè¯¥å‡½æ•°iretåè¿”å›äº†thread1æ‰§è¡Œåˆ°çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯asm_haltä¸­çš„æ­»å¾ªç¯ã€‚</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714913635709.png" alt="1714913635709"></p>
<p><img src="/2024/04/22/oslab5/oslab5/1714914114783.png" alt="1714914114783"></p>
<h3 id="Assignment-4"><a href="#Assignment-4" class="headerlink" title="Assignment 4"></a>Assignment 4</h3><p>4.1FIFO</p>
<p>ç›¸æ¯”äºassignment23ä¿®æ”¹äº†ï¼š</p>
<p>c_time_interrupt_handler()ä¸­æŠŠé˜Ÿcur-&gt;ticksçš„å¤„ç†å…¨éƒ½å»æ‰</p>
<p>çº¿ç¨‹éƒ½æ²¡æœ‰æ­»å¾ªç¯</p>
<p>void program_exit()ä¸­å¦‚æœreadyé˜Ÿåˆ—éç©ºåˆ™è¿›è¡Œè°ƒåº¦ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!programManager.readyPrograms.<span class="built_in">empty</span>())</span><br><span class="line">&#123;</span><br><span class="line">    programManager.<span class="built_in">schedule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœè§å®éªŒç»“æœ</p>
<p>4.1ä¼˜å…ˆçº§è°ƒåº¦</p>
<p>åœ¨ProgramManager::schedule()å‡½æ•°ä¸­æ‰¾å½“å‰readyé˜Ÿåˆ—ä¼˜å…ˆçº§æœ€å¤§çš„ä»»åŠ¡ï¼Œå…·ä½“ä»£ç è§å…³é”®ä»£ç éƒ¨åˆ†</p>
<p>å°†thread1,2,3çš„ä¼˜å…ˆçº§åˆ†åˆ«è®¾ç½®ä¸º1,2,3,é‚£ä¹ˆä¼šä¾æ¬¡æ‰§è¡Œthread3,2,1,ç»“æœè§å®éªŒç»“æœéƒ¨åˆ†</p>
<h2 id="3-å…³é”®ä»£ç "><a href="#3-å…³é”®ä»£ç " class="headerlink" title="3. å…³é”®ä»£ç "></a>3. <strong>å…³é”®ä»£ç </strong></h2><h3 id="Assignment1"><a href="#Assignment1" class="headerlink" title="Assignment1"></a>Assignment1</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:&#123;</span><br><span class="line">                <span class="comment">// æ¥æ”¶æµ®ç‚¹å‹ ä¿ç•™6ä¸ºå°æ•°ï¼Œä¸é‡‡å–å››èˆäº”å…¥</span></span><br><span class="line">                <span class="type">float</span> ArgFloVal = <span class="built_in">va_arg</span>(ap, <span class="type">double</span>);</span><br><span class="line">                <span class="keyword">if</span> (ArgFloVal &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, <span class="string">&#x27;-&#x27;</span>, idx, BUF_LEN);</span><br><span class="line">                    ArgFloVal = -ArgFloVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> val_seg = (<span class="type">unsigned</span> <span class="type">long</span>)ArgFloVal;<span class="comment">// å–æ•´æ•°éƒ¨åˆ†</span></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> val_temp = val_seg;      <span class="comment">// ä¸´æ—¶ä¿å­˜æ•´æ•°éƒ¨åˆ†æ•°æ®</span></span><br><span class="line">                ArgFloVal = ArgFloVal - val_seg;<span class="comment">// å¾—å‡ºä½™ä¸‹çš„å°æ•°éƒ¨åˆ†</span></span><br><span class="line">                <span class="comment">// è®¡ç®—æ•´æ•°éƒ¨åˆ†é•¿åº¦</span></span><br><span class="line">                <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (val_seg)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">while</span> (val_seg) &#123;</span><br><span class="line">                        cnt++;</span><br><span class="line">                        val_seg /= <span class="number">10</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> cnt = <span class="number">1</span>;<span class="comment">// æ•°å­—0çš„é•¿åº¦ä¸º1</span></span><br><span class="line">                <span class="comment">//counter += cnt;// å­—ç¬¦ä¸ªæ•°åŠ ä¸Šæ•´æ•°çš„é•¿åº¦</span></span><br><span class="line">                <span class="comment">// å°†æ•´æ•°è½¬ä¸ºå•ä¸ªå­—ç¬¦æ‰“å°</span></span><br><span class="line">                <span class="keyword">while</span> (cnt)</span><br><span class="line">                &#123;</span><br><span class="line">                    val_seg = val_temp / <span class="built_in">m_pow_n</span>(<span class="number">10</span>, cnt - <span class="number">1</span>);</span><br><span class="line">                    val_temp %= <span class="built_in">m_pow_n</span>(<span class="number">10</span>, cnt - <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">//my_send_char((char)val_seg + &#x27;0&#x27;);</span></span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, (<span class="type">char</span>)val_seg + <span class="string">&#x27;0&#x27;</span>, idx, BUF_LEN);</span><br><span class="line">                    cnt--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰“å°å°æ•°ç‚¹</span></span><br><span class="line">                counter += <span class="built_in">printf_add_to_buffer</span>(buffer,<span class="string">&#x27;.&#x27;</span>, idx, BUF_LEN);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¼€å§‹è¾“å‡ºå°æ•°éƒ¨åˆ†</span></span><br><span class="line">                ArgFloVal *= <span class="number">1000000</span>;</span><br><span class="line">                <span class="comment">// printf(&quot;\r\n %f\r\n&quot;, ArgFloVal);</span></span><br><span class="line">                cnt = <span class="number">6</span>;</span><br><span class="line">                val_temp = (<span class="type">int</span>)ArgFloVal;<span class="comment">// å–æ•´æ•°éƒ¨åˆ†</span></span><br><span class="line">                <span class="keyword">while</span> (cnt)</span><br><span class="line">                &#123;</span><br><span class="line">                    val_seg = val_temp / <span class="built_in">m_pow_n</span>(<span class="number">10</span>, cnt - <span class="number">1</span>);</span><br><span class="line">                    val_temp %= <span class="built_in">m_pow_n</span>(<span class="number">10</span>, cnt - <span class="number">1</span>);</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, (<span class="type">char</span>)val_seg + <span class="string">&#x27;0&#x27;</span>, idx, BUF_LEN);</span><br><span class="line">                    <span class="comment">//my_send_char((char)val_seg + &#x27;0&#x27;);</span></span><br><span class="line">                    cnt--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ret_num += 6;</span></span><br><span class="line">                <span class="comment">//pStr++;</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:&#123;</span><br><span class="line">             <span class="type">int</span> temp = <span class="built_in">va_arg</span>(ap, <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (temp &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, <span class="string">&#x27;-&#x27;</span>, idx, BUF_LEN);</span><br><span class="line">                    temp = -temp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">itos</span>(number, temp, <span class="number">10</span> );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; number[j]; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, number[j], idx, BUF_LEN);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:&#123;</span><br><span class="line">                <span class="type">int</span> temp = <span class="built_in">va_arg</span>(ap, <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (temp &lt; <span class="number">0</span> &amp;&amp; fmt[i] == <span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, <span class="string">&#x27;-&#x27;</span>, idx, BUF_LEN);</span><br><span class="line">                    temp = -temp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">itos</span>(number, temp, (fmt[i] == <span class="string">&#x27;d&#x27;</span> ? <span class="number">10</span> : <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; number[j]; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    counter += <span class="built_in">printf_add_to_buffer</span>(buffer, number[j], idx, BUF_LEN);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Assignment3"><a href="#Assignment3" class="headerlink" title="Assignment3"></a>Assignment3</h3><p>ä»£ç çš„è§£é‡Šè§å®éªŒè¿‡ç¨‹éƒ¨åˆ†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">asm_switch_thread:</span><br><span class="line">    push ebp</span><br><span class="line">    push ebx</span><br><span class="line">    push edi</span><br><span class="line">    push esi</span><br><span class="line"></span><br><span class="line">    mov eax, [esp + 5 * 4]</span><br><span class="line">    mov [eax], esp ; ä¿å­˜å½“å‰æ ˆæŒ‡é’ˆåˆ°PCBä¸­ï¼Œä»¥ä¾¿æ—¥åæ¢å¤</span><br><span class="line"></span><br><span class="line">    mov eax, [esp + 6 * 4]</span><br><span class="line">    mov esp, [eax] ; æ­¤æ—¶æ ˆå·²ç»ä»curæ ˆåˆ‡æ¢åˆ°nextæ ˆ</span><br><span class="line"></span><br><span class="line">    pop esi</span><br><span class="line">    pop edi</span><br><span class="line">    pop ebx</span><br><span class="line">    pop ebp</span><br><span class="line"></span><br><span class="line">    sti</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<h3 id="Assignment-4-1"><a href="#Assignment-4-1" class="headerlink" title="Assignment 4"></a>Assignment 4</h3><p>ä¼˜å…ˆçº§è°ƒåº¦</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProgramManager::schedule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> status = interruptManager.<span class="built_in">getInterruptStatus</span>();</span><br><span class="line">    interruptManager.<span class="built_in">disableInterrupt</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (readyPrograms.<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        interruptManager.<span class="built_in">setInterruptStatus</span>(status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (running-&gt;status == ProgramStatus::RUNNING)</span><br><span class="line">    &#123;</span><br><span class="line">        running-&gt;status = ProgramStatus::READY;</span><br><span class="line">        running-&gt;ticks = running-&gt;priority * <span class="number">10</span>;</span><br><span class="line">        readyPrograms.<span class="built_in">push_back</span>(&amp;(running-&gt;tagInGeneralList));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (running-&gt;status == ProgramStatus::DEAD)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">releasePCB</span>(running);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–max,next,nextid,readyé˜Ÿåˆ—çš„size</span></span><br><span class="line">    <span class="type">int</span> max = <span class="number">-1</span>;</span><br><span class="line">    PCB* next = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">int</span> nextid = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> size = readyPrograms.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">//æ‰¾åˆ°ä¼˜å…ˆçº§æœ€å¤§çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;size;i++)&#123;</span><br><span class="line">        ListItem* item = readyPrograms.<span class="built_in">at</span>(i);</span><br><span class="line">        PCB* tmp = <span class="built_in">ListItem2PCB</span>(item, tagInGeneralList);</span><br><span class="line">        <span class="keyword">if</span>(tmp-&gt;priority &gt; max)&#123;</span><br><span class="line">            max = tmp-&gt;priority;</span><br><span class="line">            nextid = i;</span><br><span class="line">            next = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ListItem *item = readyPrograms.front();</span></span><br><span class="line">    <span class="comment">//PCB *next = ListItem2PCB(item, tagInGeneralList);</span></span><br><span class="line">    <span class="comment">//ä»readyé˜Ÿåˆ—ä¸­å–å‡ºï¼Œå°†è¯¥çº¿ç¨‹çŠ¶æ€ç½®ä¸ºrunning</span></span><br><span class="line">    PCB *cur = running;</span><br><span class="line">    next-&gt;status = ProgramStatus::RUNNING;</span><br><span class="line">    running = next;</span><br><span class="line">    readyPrograms.<span class="built_in">erase</span>(nextid);</span><br><span class="line">    <span class="comment">//åˆ‡æ¢çº¿ç¨‹æ ˆï¼Œå®ç°çº¿ç¨‹çš„åˆ‡æ¢</span></span><br><span class="line">    <span class="built_in">asm_switch_thread</span>(cur, next);</span><br><span class="line"></span><br><span class="line">    interruptManager.<span class="built_in">setInterruptStatus</span>(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-å®éªŒç»“æœ"><a href="#4-å®éªŒç»“æœ" class="headerlink" title="4. å®éªŒç»“æœ"></a>4. <strong>å®éªŒç»“æœ</strong></h2><h4 id="Assignment1-1"><a href="#Assignment1-1" class="headerlink" title="Assignment1:"></a>Assignment1:</h4><p>printf %bï¼ˆäºŒè¿›åˆ¶ï¼‰å’Œ%f(ä¿ç•™å…­ä½å°æ•°)</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714908659141.png" alt="1714908659141"></p>
<h4 id="Assignment2"><a href="#Assignment2" class="headerlink" title="Assignment2:"></a>Assignment2:</h4><p><img src="/2024/04/22/oslab5/oslab5/1714919664301.png" alt="1714919664301"></p>
<h4 id="Assignment3-1"><a href="#Assignment3-1" class="headerlink" title="Assignment3:"></a>Assignment3:</h4><p>è§å®éªŒè¿‡ç¨‹éƒ¨åˆ†</p>
<h4 id="Assignment4"><a href="#Assignment4" class="headerlink" title="Assignment4:"></a>Assignment4:</h4><p>4.1 FIFO</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714917101307.png" alt="1714917101307"></p>
<p>4.2 ä¼˜å…ˆçº§è°ƒåº¦</p>
<p><img src="/2024/04/22/oslab5/oslab5/1714917971082.png" alt="1714917971082"></p>
<h2 id="5-å®éªŒæ€»ç»“"><a href="#5-å®éªŒæ€»ç»“" class="headerlink" title="5.å®éªŒæ€»ç»“"></a>5.å®éªŒæ€»ç»“</h2><p>é€šè¿‡è¿™æ¬¡å®éªŒï¼Œå­¦ä¹ äº†å¯å˜å‚æ•°æœºåˆ¶ï¼Œå¹¶å¢æ·»äº†å®éªŒä¸­çš„pringfå‡½æ•°çš„åŠŸèƒ½ï¼Œçº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æè¿°ï¼Œè°ƒåº¦æ–¹å¼ã€‚å¤ç°å®éªŒå¾ˆå®¹æ˜“ï¼Œä½†è¦æ·±å…¥ç†è§£å…¶ä¸­çš„æ¯ä¸€å¤„ç»†èŠ‚å¹¶å‡†ç¡®æè¿°å‡ºæ¥å¾ˆéš¾ã€‚æˆ‘åœ¨Assignment3ä¸­å¼€å§‹ç”±äºå¯¹å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ ˆçš„å˜åŒ–ä¸ç†Ÿæ‚‰å¡äº†å¾ˆä¹…ï¼Œåæ¥çœ‹åˆ°å…¶ä»–åŒå­¦çš„è§£é‡Šæ—¶æ‰æ›´åŠ æ·±å…¥ç†è§£äº† <code>asm_switch_thread</code>çš„è®¾è®¡,æ„Ÿå—åˆ°äº†è®¾è®¡çš„å·§å¦™ä¹‹å¤„ã€‚</p>
<!--åœ¨src/kernel/pragram.cppæ–‡ä»¶ä¸­ï¼Œä¼ å‚ä¸ºnullptrçš„ä½œç”¨ï¼Ÿ

ä¸ºä»€ä¹ˆä¼šè¿”å›schedule-->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/07/oslab3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/07/oslab3/" class="post-title-link" itemprop="url">SYSU-2024æ“ä½œç³»ç»Ÿlab3å®éªŒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-04-07 23:54:26" itemprop="dateCreated datePublished" datetime="2024-04-07T23:54:26+08:00">2024-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-04-08 10:15:13" itemprop="dateModified" datetime="2024-04-08T10:15:13+08:00">2024-04-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å®éªŒè¯¾ç¨‹:					æ“ä½œç³»ç»Ÿ</p>
<h1 id="å®éªŒåç§°-Lab3-ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼"><a href="#å®éªŒåç§°-Lab3-ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼" class="headerlink" title="å®éªŒåç§°:          Lab3 ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼"></a>å®éªŒåç§°:          Lab3 ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼</h1><h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><h3 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡ 1"></a>ä»»åŠ¡ 1</h3><h4 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h4><p>å¤ç°Example 1ï¼Œè¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„å¹¶æä¾›ç»“æœæˆªå›¾ï¼Œä¹Ÿå¯ä»¥å‚è€ƒUcoreã€Xv6ç­‰ç³»ç»Ÿæºç ï¼Œå®ç°è‡ªå·±çš„LBAæ–¹å¼çš„ç£ç›˜è®¿é—®ã€‚<br>æç¤ºï¼šéƒ¨åˆ†éœ€è¦çš„æ–‡ä»¶å­˜æ”¾åœ¨src&#x2F;example-1ä¸‹ï¼Œè¯·æ ¹æ®éœ€è¦å°†å…¶æ”¾ç½®äºè‡ªå·±åˆ›å»ºçš„lab3æ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<h4 id="1-2"><a href="#1-2" class="headerlink" title="1.2"></a>1.2</h4><p>åœ¨Example1ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†LBA28çš„æ–¹å¼æ¥è¯»å–ç¡¬ç›˜ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬åªè¦ç»™å‡ºé€»è¾‘æ‰‡åŒºå·å³å¯ï¼Œä½†éœ€è¦æ‰‹åŠ¨å»è¯»å–I&#x2F;Oç«¯å£ã€‚ç„¶è€Œï¼ŒBIOSæä¾›äº†å®æ¨¡å¼ä¸‹è¯»å–ç¡¬ç›˜çš„ä¸­æ–­ï¼Œå…¶ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„I&#x2F;Oç«¯å£ï¼Œåªéœ€è¦ç»™å‡ºé€»è¾‘æ‰‡åŒºå·å¯¹åº”çš„ç£å¤´ï¼ˆHeadsï¼‰ã€æ‰‡åŒºï¼ˆSectorsï¼‰å’ŒæŸ±é¢ï¼ˆCylinderï¼‰å³å¯ï¼Œåˆè¢«ç§°ä¸ºCHSæ¨¡å¼ã€‚ç°åœ¨ï¼ŒåŒå­¦ä»¬éœ€è¦å°†LBA28è¯»å–ç¡¬ç›˜çš„æ–¹å¼æ¢æˆCHSè¯»å–ï¼ŒåŒæ—¶ç»™å‡ºé€»è¾‘æ‰‡åŒºå·å‘CHSçš„è½¬æ¢å…¬å¼ã€‚æœ€åè¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„å¹¶æä¾›ç»“æœæˆªå›¾ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/04/07/oslab3/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/24/oslab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/24/oslab2/" class="post-title-link" itemprop="url">SYSU-2024æ“ä½œç³»ç»Ÿlab2å®éªŒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-24 23:54:26" itemprop="dateCreated datePublished" datetime="2024-03-24T23:54:26+08:00">2024-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-04-07 22:15:33" itemprop="dateModified" datetime="2024-04-07T22:15:33+08:00">2024-04-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ¬ç§‘ç”Ÿå®éªŒæŠ¥å‘Š</p>
<p>å®éªŒè¯¾ç¨‹:					æ“ä½œç³»ç»Ÿ</p>
<h1 id="å®éªŒåç§°-Lab2-å®éªŒå…¥é—¨"><a href="#å®éªŒåç§°-Lab2-å®éªŒå…¥é—¨" class="headerlink" title="å®éªŒåç§°:          Lab2 å®éªŒå…¥é—¨"></a>å®éªŒåç§°:          Lab2 å®éªŒå…¥é—¨</h1><h2 id="1-å®éªŒè¦æ±‚"><a href="#1-å®éªŒè¦æ±‚" class="headerlink" title="1. å®éªŒè¦æ±‚"></a>1. <strong>å®éªŒè¦æ±‚</strong></h2><h3 id="ä»»åŠ¡1ï¼š"><a href="#ä»»åŠ¡1ï¼š" class="headerlink" title="ä»»åŠ¡1ï¼š"></a><strong>ä»»åŠ¡1ï¼š</strong></h3><h4 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a><strong>1.1</strong></h4><p>æ ¹æ®Example1æ•™ç¨‹ï¼Œå¤ç°Example 1ã€‚</p>
<h4 id="1-2"><a href="#1-2" class="headerlink" title="1.2"></a><strong>1.2</strong></h4><p>ä¿®æ”¹Example 1çš„ä»£ç ï¼Œä½¿å¾—MBRè¢«åŠ è½½åˆ°0x7C00ååœ¨(12,12)å¤„å¼€å§‹è¾“å‡ºä½ çš„å­¦å·ã€‚æ³¨æ„ï¼Œå­¦å·æ˜¾ç¤ºçš„å‰æ™¯è‰²å’ŒèƒŒæ™¯è‰²å¿…é¡»å’Œæ•™ç¨‹ä¸­ä¸åŒã€‚</p>
<h3 id="ä»»åŠ¡2ï¼š"><a href="#ä»»åŠ¡2ï¼š" class="headerlink" title="ä»»åŠ¡2ï¼š"></a><strong>ä»»åŠ¡2ï¼š</strong></h3><h4 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a><strong>2.1</strong></h4><p>è¯·æ¢ç´¢å®æ¨¡å¼ä¸‹çš„å…‰æ ‡ä¸­æ–­<strong>int 10h</strong>ï¼Œ å®ç°å°†å…‰æ ‡ç§»åŠ¨è‡³(8,8)ï¼Œè·å–å¹¶è¾“å‡ºå…‰æ ‡çš„ä½ç½® ã€‚è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œå¹¶å°†ç»“æœæˆªå›¾ã€‚</p>
<h4 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a><strong>2.2</strong></h4><p>åˆ©ç”¨å®æ¨¡å¼ä¸‹çš„ä¸­æ–­ï¼Œ <strong>ä»</strong>(8,8)å¼€å§‹è¾“å‡ºä½ çš„å­¦å· ã€‚è¯´è¯´ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œå¹¶å°†ç»“æœæˆªå›¾ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/03/24/oslab2/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/23/image/assemble-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/23/image/assemble-learning/" class="post-title-link" itemprop="url">æ±‡ç¼–å­¦ä¹ </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-23 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-23T00:00:00+08:00">2024-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-05-05 23:11:25" itemprop="dateModified" datetime="2024-05-05T23:11:25+08:00">2024-05-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/2024/03/23/image/assemble-learning/%E6%B1%87%E7%BC%96/1711196825096.png" alt="1711196825096"></p>
<h1 id="å¸¸ç”¨çš„gdbè°ƒè¯•æŒ‡ä»¤"><a href="#å¸¸ç”¨çš„gdbè°ƒè¯•æŒ‡ä»¤" class="headerlink" title="å¸¸ç”¨çš„gdbè°ƒè¯•æŒ‡ä»¤"></a>å¸¸ç”¨çš„gdbè°ƒè¯•æŒ‡ä»¤</h1><table>
<thead>
<tr>
<th>gdbæŒ‡ä»¤</th>
<th>å«ä¹‰</th>
<th>å®ä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td>break *adressæˆ–b *address</td>
<td>åœ¨åœ°å€adresså¤„è®¾ç½®æ–­ç‚¹ã€‚</td>
<td>break *0x7c00&#96;&#96;b *0x7c00</td>
</tr>
<tr>
<td>break symbolæˆ–b symbol</td>
<td>åœ¨ç¬¦å·symbolå¤„è®¾ç½®æ–­ç‚¹ï¼Œä¾‹å¦‚symbolä¸€èˆ¬æ˜¯å‡½æ•°åã€‚</td>
<td>break setup_kernel&#96;&#96;b setup_kernel</td>
</tr>
<tr>
<td>break filename:line_number</td>
<td>åœ¨æ–‡ä»¶filenameå¤„çš„ç¬¬line_numerè¡Œè®¾ç½®æ–­ç‚¹</td>
<td>b mbr.asm:12</td>
</tr>
<tr>
<td>add-symbol-file filename address</td>
<td>åŠ è½½ç¬¦å·è¡¨filenameåˆ°åœ°å€addresså¤„</td>
<td>add-symbol-file mbr.symbol 0x7c00</td>
</tr>
<tr>
<td>x&#x2F;FMT address</td>
<td>addressæ˜¯å†…å­˜åœ°å€ï¼ŒFMTæ ¼å¼æ˜¯é‡å¤çš„å•å…ƒä¸ªæ•°+æ ¼å¼+å¤§å°ã€‚<br><code>é‡å¤çš„å•å…ƒä¸ªæ•°æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›æŸ¥çœ‹å¤šå°‘ä¸ªå•å…ƒã€‚æ­£æ•°è¡¨ç¤ºä»addresså‘åæŸ¥çœ‹ã€‚è´Ÿæ•°è¡¨ç¤ºä»addresså‘å‰æŸ¥çœ‹ã€‚</code>æ ¼å¼æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼Œå¯ä»¥æ˜¯o(octal), x(hex), d(decimal), u(unsigned decimal), t(binary), f(float), a(address), i(instruction), c(char), s(string)ã€‚&#96;&#96;å¤§å°æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼Œå¯ä»¥æ˜¯b(byte, 1 byte), h(halfword, 2 byte), w(word, 4 byte), g(giant, 8 bytes)ã€‚</td>
<td>x&#x2F;5xw 0x8032&#96;&#96;x&#x2F;10i 0x7c00</td>
</tr>
<tr>
<td>continueæˆ–c</td>
<td>ç»§ç»­æ‰§è¡Œæ­£åœ¨è°ƒè¯•çš„ç¨‹åºåˆ°æ–­ç‚¹å¤„æš‚åœã€‚</td>
<td></td>
</tr>
<tr>
<td>stepæˆ–s</td>
<td>æ‰§è¡Œä¸€æ¡Cè¯­å¥ï¼Œå¦‚æœé‡åˆ°å‡½æ•°è°ƒç”¨è¯­å¥ï¼Œåˆ™ä¼šè¿›å…¥å‡½æ•°ä½“ä¸­ã€‚</td>
<td></td>
</tr>
<tr>
<td>nextæˆ–n</td>
<td>æ‰§è¡Œä¸€æ¡Cè¯­å¥ï¼Œå‡½æ•°è°ƒç”¨è¯­å¥ä¸ä¼šè¿›å…¥å‡½æ•°ä½“ï¼ŒæŠŠå‡½æ•°å½“æˆä¸€æ¡è¯­å¥æ‰§è¡Œã€‚</td>
<td></td>
</tr>
<tr>
<td>stepiæˆ–si</td>
<td>æ‰§è¡Œä¸€æ¡æ±‡ç¼–è¯­å¥ï¼Œå¦‚æœé‡åˆ°å‡½æ•°è°ƒç”¨è¯­å¥ï¼Œåˆ™ä¼šè¿›å…¥å‡½æ•°ä½“ä¸­ã€‚</td>
<td></td>
</tr>
<tr>
<td>nextiæˆ–ni</td>
<td>æ‰§è¡Œä¸€æ¡æ±‡ç¼–è¯­å¥ï¼Œå‡½æ•°è°ƒç”¨è¯­å¥ä¸ä¼šè¿›å…¥å‡½æ•°ä½“ï¼ŒæŠŠå‡½æ•°å½“æˆä¸€æ¡è¯­å¥æ‰§è¡Œã€‚</td>
<td></td>
</tr>
<tr>
<td>info registers</td>
<td>æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨çš„å€¼</td>
<td></td>
</tr>
<tr>
<td>layout layout_name</td>
<td>layout_nameåŒ…å«srcï¼Œasmï¼Œsplitï¼Œregsã€‚&#96;&#96;srcæ˜¾ç¤ºæºä»£ç çª—å£å’Œå‘½ä»¤çª—å£ï¼Œasmæ˜¾ç¤ºæ±‡ç¼–ä»£ç çª—å£å’Œå‘½ä»¤çª—å£ï¼Œsplitæ˜¾ç¤ºæºä»£ç çª—å£ã€æ±‡ç¼–ä»£ç çª—å£å’Œå‘½ä»¤çª—å£ï¼Œregsæ˜¾ç¤ºå¯„å­˜å™¨çª—å£ã€‚</td>
<td>layout split</td>
</tr>
<tr>
<td>focus layout_window</td>
<td>è½¬æ¢å½“å‰çª—å£åˆ°layoutçª—å£ï¼Œlayout_windowåŒ…å«srcï¼Œasmï¼Œregsï¼Œcmdã€‚ä»»ä½•æ—¶åˆ»gdbçš„å½“å‰çª—å£åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”ä½¿ç”¨æ–¹å‘é”®çš„æ•ˆæœåªä¼šåœ¨å½“å‰çª—å£å¤„æ˜¾ç¤ºã€‚</td>
<td>focus cmd</td>
</tr>
<tr>
<td>file symbol_file</td>
<td>åŠ è½½ç¬¦å·è¡¨ï¼Œä¸ºgdbæä¾›debugä¿¡æ¯ã€‚</td>
<td>file ..&#x2F;build&#x2F;kernel.o</td>
</tr>
<tr>
<td>set disassembly-flavor intel</td>
<td>è®¾ç½®æ±‡ç¼–ä»£ç æ ¼å¼ä¸ºintelé£æ ¼</td>
<td></td>
</tr>
<tr>
<td>set architecture name</td>
<td>è®¾ç½®æŒ‡ä»¤å¯¹åº”çš„CPUæ¶æ„ï¼ŒnameåŒ…å«i8086(16ä½)ï¼Œi386(32ä½)</td>
<td>set architecture i386</td>
</tr>
</tbody></table>
<p>è¯¦è§£å­ç¨‹åºè°ƒç”¨è¿‡ç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">asm_switch_thread:</span><br><span class="line">    push ebp</span><br><span class="line">    push ebx</span><br><span class="line">    push edi</span><br><span class="line">    push esi</span><br><span class="line"></span><br><span class="line">    mov eax, [esp + 5 * 4]</span><br><span class="line">    mov [eax], esp ; ä¿å­˜å½“å‰æ ˆæŒ‡é’ˆåˆ°PCBä¸­ï¼Œä»¥ä¾¿æ—¥åæ¢å¤</span><br><span class="line"></span><br><span class="line">    mov eax, [esp + 6 * 4]</span><br><span class="line">    mov esp, [eax] ; æ­¤æ—¶æ ˆå·²ç»ä»curæ ˆåˆ‡æ¢åˆ°nextæ ˆ</span><br><span class="line"></span><br><span class="line">    pop esi</span><br><span class="line">    pop edi</span><br><span class="line">    pop ebx</span><br><span class="line">    pop ebp</span><br><span class="line"></span><br><span class="line">    sti</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>1.pushæŒ‡ä»¤</p>
<p>push %eax</p>
<p>å°†eaxæ•°å€¼å‹å…¥æ ˆä¸­ï¼Œå¯åˆ†è§£ä¸ºï¼š</p>
<p>sub $4, %esp â€”â€”&gt; esp &#x3D; esp - 4</p>
<p>mov %eax, (%esp) â€”â€”&gt; *(int32_t *)esp &#x3D; eax</p>
<p>2.popæŒ‡ä»¤</p>
<p>pop %eax</p>
<p>å°†eaxæ•°å€¼å¼¹å‡ºæ ˆï¼Œå¯åˆ†è§£ä¸ºï¼š</p>
<p>mov (%esp), %eax â€”â€”&gt; eax &#x3D; *(int32_t *)esp</p>
<p>add $4, %esp â€”â€”&gt; esp &#x3D; esp + 4</p>
<p>3.callæŒ‡ä»¤</p>
<p>call 0x12345</p>
<p>è°ƒç”¨0x12345è¿™ä¸ªåœ°å€ï¼Œå¯åˆ†è§£ä¸ºï¼š</p>
<p>push %eip â€”â€”&gt; å°†cpuä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤å‹å…¥æ ˆä¸­</p>
<p>mov $0x12345, %eip â€”â€”&gt; eip &#x3D; 0x12345</p>
<p>æ³¨æ„ï¼šCPUä¸‹ä¸€æ¡æŒ‡ä»¤å°†ä¼šä»åœ°å€0x12345ä¸­å–ã€‚</p>
<p>4.retæŒ‡ä»¤</p>
<p>ret</p>
<p>è¿”å›callä¹‹å‰çš„åœ°å€ï¼Œå¯åˆ†è§£ä¸ºï¼š</p>
<p>pop %eip â€”â€”&gt; å°†callå‹å…¥æ ˆçš„æŒ‡ä»¤å¼¹å‡ºèµ‹ç»™eip</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/21/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/21/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-21 19:51:45" itemprop="dateCreated datePublished" datetime="2024-03-21T19:51:45+08:00">2024-03-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/oslab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zyh">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yhzhuang">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/10/oslab1/" class="post-title-link" itemprop="url">æ“ä½œç³»ç»Ÿlab1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-03-10 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-10T00:00:00+08:00">2024-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-03-25 01:37:26" itemprop="dateModified" datetime="2024-03-25T01:37:26+08:00">2024-03-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>sf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dfsf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/10/oslab1/1711029383714.png" alt="1711029383714"></p>
<p><strong>æœ¬ç§‘ç”Ÿå®éªŒæŠ¥å‘Š</strong></p>
<p>å®éªŒè¯¾ç¨‹:					æ“ä½œç³»ç»Ÿ</p>
<h1 id="å®éªŒåç§°-lab1-ç¼–è¯‘å†…æ ¸-åˆ©ç”¨å·²æœ‰å†…æ ¸æ„å»ºOS"><a href="#å®éªŒåç§°-lab1-ç¼–è¯‘å†…æ ¸-åˆ©ç”¨å·²æœ‰å†…æ ¸æ„å»ºOS" class="headerlink" title="å®éªŒåç§°: lab1 ç¼–è¯‘å†…æ ¸&#x2F;åˆ©ç”¨å·²æœ‰å†…æ ¸æ„å»ºOS"></a>å®éªŒåç§°: lab1 ç¼–è¯‘å†…æ ¸&#x2F;åˆ©ç”¨å·²æœ‰å†…æ ¸æ„å»ºOS</h1><ol>
<li><strong>å®éªŒè¦æ±‚</strong></li>
</ol>
<p>ç‹¬ç«‹å®Œæˆå®éªŒ5ä¸ªéƒ¨åˆ† <strong>ç¯å¢ƒé…ç½®</strong> ã€ <strong>ç¼–è¯‘****Linuxå†…æ ¸</strong>ã€ <strong>Qemuå¯åŠ¨å†…æ ¸å¹¶å¼€å¯è¿œç¨‹è°ƒè¯•</strong> ã€<strong>åˆ¶ä½œ<strong><strong>Initramfs</strong></strong></strong>å’Œ <strong>ç¼–è¯‘å¹¶å¯åŠ¨</strong>Busybox**** ã€‚</p>
<p>1.æ­å»ºOSå†…æ ¸å¼€å‘ç¯å¢ƒåŒ…æ‹¬ï¼šä»£ç ç¼–è¾‘ç¯å¢ƒã€ç¼–è¯‘ç¯å¢ƒã€è¿è¡Œç¯å¢ƒã€è°ƒè¯•ç¯å¢ƒç­‰ã€‚</p>
<p>2.ä¸‹è½½å¹¶ç¼–è¯‘i386ï¼ˆ32ä½ï¼‰å†…æ ¸ï¼Œå¹¶åˆ©ç”¨qemuå¯åŠ¨å†…æ ¸ã€‚</p>
<p>3.ç†Ÿæ‚‰åˆ¶ä½œinitramfsçš„æ–¹æ³•ã€‚</p>
<p>4.ç¼–å†™ç®€å•åº”ç”¨ç¨‹åºéšå†…æ ¸å¯åŠ¨è¿è¡Œã€‚</p>
<p>5.ç¼–è¯‘i386ç‰ˆæœ¬çš„Busyboxï¼Œéšå†…æ ¸å¯åŠ¨ï¼Œæ„å»ºç®€å•çš„OSã€‚</p>
<p>6.å¼€å¯è¿œç¨‹è°ƒè¯•åŠŸèƒ½ï¼Œè¿›è¡Œè°ƒè¯•è·Ÿè¸ªä»£ç è¿è¡Œã€‚</p>
<p>7.æ’°å†™å®éªŒæŠ¥å‘Šã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/03/10/oslab1/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zyh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zyh</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
